<!-- views/partials/_post_form.ejs -->
<% const noForm   = !!locals.noForm; %>
<% const editMode = !!locals.editMode; %>
<% const post     = locals.post || null; %>
<%
  const existing =
    (typeof post !== 'undefined' && post && post.richText)
      ? post.richText
      : '';
%>

<% const formAction = editMode && post
  ? `/${company.slug}/posts/${post._id}`
  : `/${company.slug}/posts`;
%>

<% if (!noForm) { %>
<form method="POST"
      action="<%= formAction %>"
      enctype="multipart/form-data"
      class="composer-card"
      id="composerForm" novalidate>
<% } %>

  <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

  <!-- ‚úÖ for drafts/edit: controller will read intent -->
  <input type="hidden" name="intent" id="intentField" value="<%= editMode ? 'draft' : 'publish' %>">

  <!-- ‚úÖ keep for create-draft flow (optional) -->
  <input type="hidden" name="saveAsDraft" id="saveAsDraft" value="0">

  <input type="hidden" name="type" id="postTypeSel" value="<%= post?.type || 'TEXT' %>">


  <% if (typeof groupId !== 'undefined' && groupId) { %>
    <input type="hidden" name="groupId" value="<%= groupId %>">
  <% } %>

  <!-- Header -->
  <div class="composer-head">
    <img class="composer-avatar" src="<%= (currentUser?.avatarUrl || '/img/avatar.png') %>" alt="">
    <div class="composer-head-meta">
      <div class="composer-hint">
        <%= currentUser ? `What's on your mind, ${currentUser.fullName?.split(' ')[0] || ''}?` : 'Start a post' %>
      </div>
    </div>
  </div>

  <!-- Textarea -->
  <div id="plainComposerWrap">
    <textarea name="content"
  id="composerTextarea"
  rows="1"
  class="composer-input js-mention"
  data-mention-source="/<%= company.slug %>/posts/mentions"
  placeholder="Write something‚Ä¶ (paste a link to show a preview)"
><%- existing %></textarea>

  </div>

  <!-- Toolbar -->
  <div class="composer-toolbar">
    <div class="composer-toolbar-left">
      <!-- (keep your type buttons as-is) -->
      <button type="button" class="composer-icon-btn tsel" data-type="IMAGE" title="Image post" aria-label="Image post">
        <span class="icon" aria-hidden="true">üñºÔ∏è</span>
      </button>
      <button type="button" class="composer-icon-btn tsel" data-type="POLL" title="Create poll" aria-label="Create poll">
        <span class="icon" aria-hidden="true">üìä</span>
      </button>
      <button type="button" class="composer-icon-btn tsel" data-type="ANNOUNCEMENT" title="Announcement" aria-label="Announcement">
        <span class="icon" aria-hidden="true">üì¢</span>
      </button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <button type="button" class="btn btn-ghost" id="draftBtn">
        Save draft
      </button>

      <button
        class="composer-post-btn"
        type="submit"
        id="postBtn"
        disabled
        title="<%= editMode ? 'Publish' : 'Post' %>"
        aria-label="<%= editMode ? 'Publish' : 'Post' %>"
      >
        <span class="composer-post-icon" aria-hidden="true">‚û§</span>
      </button>
    </div>
  </div>

  <!-- (keep your remaining fields: file input, poll builder, announcement fields, etc.) -->

  <% if (!noForm) { %>
    </form>
  <% } %>

<script>
(function(){
  const form      = document.getElementById('composerForm');
  if (!form) return;

  const typeSel   = document.getElementById('postTypeSel');
  const postBtn   = document.getElementById('postBtn');
  const textarea  = document.getElementById('composerTextarea');

  const draftBtn  = document.getElementById('draftBtn');
  const draftFlag = document.getElementById('saveAsDraft');
  const intentField = document.getElementById('intent');

  const IS_EDIT = <%= editMode ? 'true' : 'false' %>;

  function enableIfHasContent(){
    const hasText = (textarea.value || '').trim().length > 0;
    postBtn.disabled = !hasText;
  }

  textarea.addEventListener('input', enableIfHasContent);

  // ‚úÖ Save Draft
  if (draftBtn) {
    draftBtn.addEventListener('click', () => {
      if (IS_EDIT) {
        // edit flow -> updatePost expects intent
        intentField.value = 'draft';
      } else {
        // create flow -> create() expects saveAsDraft=1
        draftFlag.value = '1';
      }
      form.requestSubmit ? form.requestSubmit() : form.submit();
    });
  }

  // ‚úÖ Publish / Post (arrow)
  postBtn.addEventListener('click', () => {
    if (IS_EDIT) {
      intentField.value = 'publish';
    } else {
      draftFlag.value = '0';
    }
  });

  // Initial
  enableIfHasContent();
})();
</script>


<script>
(function(){
  const form      = document.getElementById('composerForm');
  if (!form) return;

  const typeSel   = document.getElementById('postTypeSel');
  const fileInp   = document.getElementById('composerFile');
  const postBtn   = document.getElementById('postBtn');
  const imageRow  = document.getElementById('imageRow');
  const pollBuilder = form.querySelector('.poll-builder');
  const announceRow = document.getElementById('announceRow');
  const pbQs        = form.querySelector('.pb-questions');
  const addQ        = form.querySelector('.pb-add-q');
  const plainWrap   = document.getElementById('plainComposerWrap');
  const annWrap     = document.getElementById('announcementEditorWrap');
  const textarea    = document.getElementById('composerTextarea');

  const intentField = document.getElementById('intentField');
  const draftBtn = document.getElementById('draftBtn');
  const postBtn  = document.getElementById('postBtn');

  if (draftBtn && intentField) {
    draftBtn.addEventListener('click', () => {
      intentField.value = 'draft';
      form.requestSubmit ? form.requestSubmit() : form.submit();
    });
  }

  if (postBtn && intentField) {
    postBtn.addEventListener('click', () => {
      intentField.value = 'publish';
    });
  }


  let annQuill = null;
  function ensureAnnQuill() {
    if (annQuill || !window.Quill) return;
    annQuill = new Quill('#announcementEditor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link', 'image'],
          ['clean']
        ]
      }
    });
    annQuill.on('text-change', enableIfHasContent);
    // If editing: seed quill with existing HTML
    const existingHtml = (textarea.value || '').trim();
    if (existingHtml && existingHtml.includes('<')) {
      annQuill.root.innerHTML = existingHtml;
    }
  }

  function setType(t){
    typeSel.value = t;
    imageRow.classList.toggle('d-none', t !== 'IMAGE');
    pollBuilder.classList.toggle('d-none', t !== 'POLL');
    announceRow.classList.toggle('d-none', t !== 'ANNOUNCEMENT');

    if (t === 'ANNOUNCEMENT') {
      ensureAnnQuill();
      plainWrap?.classList.add('d-none');
      annWrap?.classList.remove('d-none');
    } else {
      plainWrap?.classList.remove('d-none');
      annWrap?.classList.add('d-none');
    }
  }

  function autoGrow(el){
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 320) + 'px';
  }

  function enableIfHasContent(){
    let hasText = false;
    if (typeSel.value === 'ANNOUNCEMENT' && annQuill) {
      hasText = annQuill.getText().trim().length > 0;
    } else {
      hasText = (textarea.value || '').trim().length > 0;
    }
    const hasMedia = !!(fileInp.files && fileInp.files.length);
    const hasPoll = (typeSel.value === 'POLL') && pbQs && pbQs.querySelectorAll('.pb-q').length > 0;
    postBtn.disabled = !(hasText || hasMedia || hasPoll);
  }

  // textarea input
  autoGrow(textarea);
  textarea.addEventListener('input', () => { autoGrow(textarea); enableIfHasContent(); });

  // Type icon clicks
  form.querySelectorAll('.tsel').forEach(btn => {
    btn.addEventListener('click', () => {
      const t = btn.getAttribute('data-type');
      setType(t);

      if (t === 'IMAGE') fileInp?.click();

      if (t === 'POLL' && pbQs && !pbQs.querySelector('.pb-q')) {
        pbQs.appendChild(renderQuestion(0, null));
      }
      enableIfHasContent();
    });
  });

  // Media preview
  const mediaPreview = document.getElementById('mediaPreview');
  const mediaGrid    = document.getElementById('mediaGrid');
  const removeMediaPreview = document.getElementById('removeMediaPreview');

  function resetMediaPreview(){
    if (mediaGrid) mediaGrid.innerHTML = '';
    mediaPreview?.classList.add('d-none');
    if (fileInp) fileInp.value = '';
    if (typeSel.value === 'IMAGE') setType('TEXT');
  }

  fileInp.addEventListener('change', () => {
    const files = Array.from(fileInp.files || []);
    if (!files.length) { resetMediaPreview(); enableIfHasContent(); return; }

    if (files.length > 6) { alert('Please select up to 6 images.'); resetMediaPreview(); return; }
    const tooBig = files.find(f => f.size > 2 * 1024 * 1024);
    const notImg = files.find(f => !/^image\//i.test(f.type));
    if (notImg) { alert('Only images are supported.'); resetMediaPreview(); return; }
    if (tooBig) { alert('Each image must be ‚â§ 2 MB.'); resetMediaPreview(); return; }

    mediaGrid.innerHTML = '';
    files.forEach(f => {
      const url = URL.createObjectURL(f);
      const img = document.createElement('img');
      img.src = url;
      mediaGrid.appendChild(img);
    });
    mediaPreview.classList.remove('d-none');
    setType('IMAGE');
    enableIfHasContent();
  });

  removeMediaPreview?.addEventListener('click', () => { resetMediaPreview(); enableIfHasContent(); });

  // Draft button
  draftBtn?.addEventListener('click', () => {
    if (intentInp) intentInp.value = 'draft';
    if (draftFlag) draftFlag.value = '1';
    form.requestSubmit ? form.requestSubmit() : form.submit();
  });

  // Normal submit (publish)
  form.addEventListener('submit', () => {
    if (intentInp && intentInp.value !== 'draft') intentInp.value = 'publish';
    if (typeSel.value === 'ANNOUNCEMENT' && annQuill) {
      textarea.value = annQuill.root.innerHTML; // send HTML
    }
  });

  // Poll builder (same as yours, kept minimal)
  function qName(i, inner){ return `poll[questions][${i}]` + (inner ? `[${inner}]` : ''); }
  function optName(i, j){ return `poll[questions][${i}][options][${j}]`; }

  function renderQuestion(i, data){
    const wrap = document.createElement('div');
    wrap.className = 'pb-q';
    wrap.style = 'border:1px dashed #ddd;border-radius:8px;padding:8px;margin:8px 0;';
    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <div style="font-weight:600;">Question ${i+1}</div>
        <div>
          <label style="font-size:12px;">
            <input type="checkbox" name="${qName(i,'multiSelect')}" ${data?.multiSelect ? 'checked':''}>
            Multiple answers allowed
          </label>
          <button type="button" class="btn" data-del-q>Remove</button>
        </div>
      </div>
      <input type="text" name="${qName(i,'text')}" class="input" placeholder="Question text"
             value="${(data?.text||'').replace(/"/g,'&quot;')}" style="margin:6px 0;max-width:520px;">
      <div class="pb-opts"></div>
      <button type="button" class="btn" data-add-opt>+ Add option</button>
    `;
    const optsWrap = wrap.querySelector('.pb-opts');
    const addOptBtn = wrap.querySelector('[data-add-opt]');
    const delQBtn = wrap.querySelector('[data-del-q]');

    function renderOpt(j, label){
      const row = document.createElement('div');
      row.className = 'pb-opt';
      row.style = 'display:flex;gap:6px;align-items:center;margin:4px 0;';
      row.innerHTML = `
        <input type="text" class="input" name="${optName(i,j)}[label]" placeholder="Option ${j+1}"
               value="${(label||'').replace(/"/g,'&quot;')}" style="max-width:420px;">
        <button type="button" class="btn" data-del-opt title="Remove option">√ó</button>
      `;
      row.querySelector('[data-del-opt]').addEventListener('click', () => { row.remove(); enableIfHasContent(); });
      optsWrap.appendChild(row);
    }

    addOptBtn.addEventListener('click', () => {
      const count = optsWrap.querySelectorAll('.pb-opt').length;
      if (count >= 10) return alert('Max 10 options per question.');
      renderOpt(count, '');
      enableIfHasContent();
    });

    delQBtn.addEventListener('click', () => { wrap.remove(); enableIfHasContent(); });

    const seed = Array.isArray(data?.options) && data.options.length ? data.options.map(o=>o.label) : ['',''];
    seed.forEach((lbl, j) => renderOpt(j, lbl||''));
    return wrap;
  }

  addQ?.addEventListener('click', () => {
    const count = pbQs.querySelectorAll('.pb-q').length;
    if (count >= 10) return alert('Max 10 questions per poll.');
    pbQs.appendChild(renderQuestion(count, null));
    enableIfHasContent();
  });

  // initial
  setType(typeSel.value || 'TEXT');
  enableIfHasContent();
})();
</script>
