<!-- views/partials/_post_form.ejs -->
<% const noForm   = !!locals.noForm; %>
<% const editMode = !!locals.editMode; %>
<% const post     = locals.post || null; %>
<%
  const existing =
    (typeof post !== 'undefined' && post && post.richText)
      ? post.richText
      : '';
%>

<% const formAction = editMode && post
  ? `/${company.slug}/posts/${post._id}`
  : `/${company.slug}/posts`;
%>

<% if (!noForm) { %>
<form method="POST"
      action="<%= formAction %>"
      enctype="multipart/form-data"
      class="composer-card"
      id="composerForm" novalidate>
<% } %>

  <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

  <!-- ‚úÖ for drafts/edit: controller will read intent -->
  <input type="hidden" name="intent" id="intentField" value="<%= editMode ? 'draft' : 'publish' %>">

  <!-- ‚úÖ keep for create-draft flow (optional) -->
  <input type="hidden" name="saveAsDraft" id="saveAsDraft" value="0">

  <input type="hidden" name="type" id="postTypeSel" value="<%= post?.type || 'TEXT' %>">


  <% if (typeof groupId !== 'undefined' && groupId) { %>
    <input type="hidden" name="groupId" value="<%= groupId %>">
  <% } %>


  <div class="composer-row">
    <input
      id="post-text"
      class="composer-input"
      type="text"
      name="text"
      placeholder="Write something... (paste a link to show a preview)"
      autocomplete="off"
    />
  
    <div class="composer-actions" role="group" aria-label="Post actions">

      <!-- POST FIRST -->
      <button class="composer-post-btn" type="submit" title="Post">
        <span class="composer-post-icon">‚û§</span>
      </button>
    
      <!-- SAVE DRAFT SECOND -->
      <button id="draftBtn" class="composer-draft-btn" type="button">
        Save draft
      </button>
    
      <!-- ICON BUTTONS AFTER -->
      <button class="composer-icon-btn" type="button" title="Image" data-type="IMAGE">üñºÔ∏è</button>
      <button class="composer-icon-btn" type="button" title="Poll" data-type="POLL">üìä</button>
      <button class="composer-icon-btn" type="button" title="Announcement" data-type="ANNOUNCEMENT">üì¢</button>
    
    </div>
    
    
  
  </div>
  
  

    <!-- IMAGE upload (required for IMAGE button) -->
    <input
    type="file"
    id="composerFile"
    name="images"
    accept="image/*"
    multiple
    hidden
  />

 <!-- IMAGE row -->
<div id="imageRow" class="d-none composer-section" style="margin-top:10px;">
  <div id="mediaPreview" class="d-none media-preview-card">
    <div id="mediaGrid" class="mediaGrid mediaGrid--composer"></div>
    <button type="button" id="removeMediaPreview" class="btn btn-ghost media-remove-btn">Remove images</button>
  </div>
</div>

<!-- POLL builder -->
<div class="poll-builder d-none composer-section poll-builder--card" style="margin-top:12px;">
  <div class="pb-questions"></div>
  <button type="button" class="btn pb-add-q">+ Add question</button>
</div>

<!-- ANNOUNCEMENT editor -->
<div id="announceRow" class="d-none composer-section announce--card" style="margin-top:12px;">
  <div id="announcementEditorWrap" class="d-none">
    <div class="rich-editor-container rich-editor-container--clean">
      <div id="announcementEditor"></div>
    </div>
  </div>

  <div class="announce-fields">
    <input type="text" name="title" placeholder="Announcement title (optional)" class="input announce-title" />
    <input type="file" name="coverImage" accept="image/*" class="input announce-cover" />
  </div>
</div>


  <!-- (keep your remaining fields: file input, poll builder, announcement fields, etc.) -->

  <% if (!noForm) { %>
    </form>
  <% } %>

<script>
(function(){
  const form = document.getElementById('composerForm');
  if (!form) return;

  const typeSel   = document.getElementById('postTypeSel');
  const textarea  = document.getElementById('composerTextarea');
  const postBtn   = document.getElementById('postBtn');

  // IMPORTANT: your hidden input is id="intentField"
  const intentField = document.getElementById('intentField');
  const draftFlag   = document.getElementById('saveAsDraft');
  const draftBtn    = document.getElementById('draftBtn');

  // Optional sections (may or may not exist depending on your partial)
  const fileInp      = document.getElementById('composerFile');         // must match your <input id="">
  const imageRow     = document.getElementById('imageRow');
  const pollBuilder  = form.querySelector('.poll-builder');
  const announceRow  = document.getElementById('announceRow');
  const pbQs         = form.querySelector('.pb-questions');
  const addQ         = form.querySelector('.pb-add-q');
  const plainWrap    = document.getElementById('plainComposerWrap');
  const annWrap      = document.getElementById('announcementEditorWrap');

  const mediaPreview = document.getElementById('mediaPreview');
  const mediaGrid    = document.getElementById('mediaGrid');
  const removeMediaPreview = document.getElementById('removeMediaPreview');

  let annQuill = null;

  function ensureAnnQuill() {
    if (annQuill || !window.Quill) return;
    const editorEl = document.getElementById('announcementEditor');
    if (!editorEl) return;

    annQuill = new Quill('#announcementEditor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link', 'image'],
          ['clean']
        ]
      }
    });

    annQuill.on('text-change', enableIfHasContent);

    // If editing: seed quill with existing HTML
    const existingHtml = (textarea?.value || '').trim();
    if (existingHtml && existingHtml.includes('<')) {
      annQuill.root.innerHTML = existingHtml;
    }
  }

  function setType(t){
    if (typeSel) typeSel.value = t;

    imageRow?.classList.toggle('d-none', t !== 'IMAGE');
    pollBuilder?.classList.toggle('d-none', t !== 'POLL');
    announceRow?.classList.toggle('d-none', t !== 'ANNOUNCEMENT');

    if (t === 'ANNOUNCEMENT') {
      ensureAnnQuill();
      plainWrap?.classList.add('d-none');
      annWrap?.classList.remove('d-none');
    } else {
      plainWrap?.classList.remove('d-none');
      annWrap?.classList.add('d-none');
    }
  }

  function autoGrow(el){
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 320) + 'px';
  }

  function enableIfHasContent(){
    let hasText = false;

    const currentType = (typeSel?.value || 'TEXT');
    if (currentType === 'ANNOUNCEMENT' && annQuill) {
      hasText = annQuill.getText().trim().length > 0;
    } else {
      hasText = (textarea?.value || '').trim().length > 0;
    }

    const hasMedia = !!(fileInp?.files && fileInp.files.length);
    const hasPoll  = (currentType === 'POLL') && !!pbQs?.querySelector('.pb-q');

    if (postBtn) postBtn.disabled = !(hasText || hasMedia || hasPoll);
  }

  // Textarea
  autoGrow(textarea);
  textarea?.addEventListener('input', () => { autoGrow(textarea); enableIfHasContent(); });

  // Type icon clicks
  form.querySelectorAll('.composer-icon-btn[data-type]').forEach(btn => {
    btn.addEventListener('click', () => {
      const t = btn.getAttribute('data-type');
      setType(t);

      // IMAGE: open picker
      if (t === 'IMAGE') fileInp?.click();

      // POLL: seed one question if none
      if (t === 'POLL' && pbQs && !pbQs.querySelector('.pb-q')) {
        pbQs.appendChild(renderQuestion(0, null));
      }

      enableIfHasContent();
    });
  });

  // Draft
  draftBtn?.addEventListener('click', () => {
    if (intentField) intentField.value = 'draft';
    if (draftFlag) draftFlag.value = '1';
    form.requestSubmit ? form.requestSubmit() : form.submit();
  });

  // Publish
  postBtn?.addEventListener('click', () => {
    if (intentField) intentField.value = 'publish';
    if (draftFlag) draftFlag.value = '0';
  });

  // Media preview
  function resetMediaPreview(){
    if (mediaGrid) mediaGrid.innerHTML = '';
    mediaPreview?.classList.add('d-none');
    if (fileInp) fileInp.value = '';
    if ((typeSel?.value || '') === 'IMAGE') setType('TEXT');
  }

  fileInp?.addEventListener('change', () => {
    const files = Array.from(fileInp.files || []);
    if (!files.length) { resetMediaPreview(); enableIfHasContent(); return; }

    if (files.length > 6) { alert('Please select up to 6 images.'); resetMediaPreview(); return; }
    const tooBig = files.find(f => f.size > 2 * 1024 * 1024);
    const notImg = files.find(f => !/^image\//i.test(f.type));
    if (notImg) { alert('Only images are supported.'); resetMediaPreview(); return; }
    if (tooBig) { alert('Each image must be ‚â§ 2 MB.'); resetMediaPreview(); return; }

    if (mediaGrid) mediaGrid.innerHTML = '';
    files.forEach(f => {
      const url = URL.createObjectURL(f);
      const img = document.createElement('img');
      img.src = url;
      mediaGrid?.appendChild(img);
    });

    mediaPreview?.classList.remove('d-none');
    setType('IMAGE');
    enableIfHasContent();
  });

  removeMediaPreview?.addEventListener('click', () => {
    resetMediaPreview();
    enableIfHasContent();
  });

  // Submit: if ANNOUNCEMENT, copy Quill HTML into textarea
  form.addEventListener('submit', () => {
    const currentType = (typeSel?.value || 'TEXT');
    if (currentType === 'ANNOUNCEMENT' && annQuill && textarea) {
      textarea.value = annQuill.root.innerHTML;
    }
  });


  // Poll builder helpers (same logic, but safe)
  function qName(i, inner){ return `poll[questions][${i}]` + (inner ? `[${inner}]` : ''); }
  function optName(i, j){ return `poll[questions][${i}][options][${j}]`; }

  function renderQuestion(i, data){
    const wrap = document.createElement('div');
    wrap.className = 'pb-q';
    wrap.style = 'border:1px dashed #ddd;border-radius:8px;padding:8px;margin:8px 0;';
    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <div style="font-weight:600;">Question ${i+1}</div>
        <div>
          <label style="font-size:12px;">
            <input type="checkbox" name="${qName(i,'multiSelect')}" ${data?.multiSelect ? 'checked':''}>
            Multiple answers allowed
          </label>
          <button type="button" class="btn" data-del-q>Remove</button>
        </div>
      </div>
      <input type="text" name="${qName(i,'text')}" class="input" placeholder="Question text"
             value="${(data?.text||'').replace(/"/g,'&quot;')}" style="margin:6px 0;max-width:520px;">
      <div class="pb-opts"></div>
      <button type="button" class="btn" data-add-opt>+ Add option</button>
    `;

    const optsWrap = wrap.querySelector('.pb-opts');
    const addOptBtn = wrap.querySelector('[data-add-opt]');
    const delQBtn = wrap.querySelector('[data-del-q]');

    function renderOpt(j, label){
      const row = document.createElement('div');
      row.className = 'pb-opt';
      row.style = 'display:flex;gap:6px;align-items:center;margin:4px 0;';
      row.innerHTML = `
        <input type="text" class="input" name="${optName(i,j)}[label]" placeholder="Option ${j+1}"
               value="${(label||'').replace(/"/g,'&quot;')}" style="max-width:420px;">
        <button type="button" class="btn" data-del-opt title="Remove option">√ó</button>
      `;
      row.querySelector('[data-del-opt]').addEventListener('click', () => { row.remove(); enableIfHasContent(); });
      optsWrap?.appendChild(row);
    }

    addOptBtn?.addEventListener('click', () => {
      const count = optsWrap?.querySelectorAll('.pb-opt').length || 0;
      if (count >= 10) return alert('Max 10 options per question.');
      renderOpt(count, '');
      enableIfHasContent();
    });

    delQBtn?.addEventListener('click', () => { wrap.remove(); enableIfHasContent(); });

    const seed = Array.isArray(data?.options) && data.options.length ? data.options.map(o=>o.label) : ['',''];
    seed.forEach((lbl, j) => renderOpt(j, lbl||''));
    return wrap;
  }

  addQ?.addEventListener('click', () => {
    const count = pbQs?.querySelectorAll('.pb-q').length || 0;
    if (count >= 10) return alert('Max 10 questions per poll.');
    pbQs?.appendChild(renderQuestion(count, null));
    enableIfHasContent();
  });

  // Initial
  setType(typeSel?.value || 'TEXT');
  enableIfHasContent();
})();
</script>

