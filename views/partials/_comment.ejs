<li class="comment-card" data-comment-id="<%= comment._id %>">
  <div class="comment-header">
    <div>
      <span class="comment-author"><%= comment.authorId?.fullName || 'User' %></span>
      <span class="comment-time">• <%= new Date(comment.createdAt).toLocaleString() %></span>
    </div>

    <% if (
      user && (
        String(user._id) === String(comment.authorId?._id || comment.authorId) ||
        ['ORG_ADMIN','MODERATOR'].includes(user.role)
      )
    ) { %>
      <form method="POST"
            action="/<%= company.slug %>/posts/<%= post._id %>/comments/<%= comment._id %>/delete"
            onsubmit="return confirm('Delete this comment?')">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <button class="btn btn-ghost btn-sm" type="submit">Delete</button>
      </form>
    <% } %>
  </div>

  <% if (comment.status === 'deleted') { %>
    <div class="comment-content"><em>(deleted)</em></div>
  <% } else { %>
    <div class="comment-content"><%- comment.content %></div>
  <% } %>

  <div class="comment-actions">
    <% if (user && comment.status !== 'deleted') { %>
      <a href="#" class="btn-link" data-reply-toggle="<%= comment._id %>">Reply</a>
    <% } %>
    <small><%= (comment.repliesCount || 0) %> repl<%= (comment.repliesCount || 0) === 1 ? 'y' : 'ies' %></small>
  </div>

  <% if (user && comment.status !== 'deleted') { %>
    <form id="reply-form-<%= comment._id %>"
          method="POST"
          action="/<%= company.slug %>/posts/<%= post._id %>/comments"
          class="reply-form"
          style="display:none;">
      <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
      <input type="hidden" name="parentCommentId" value="<%= comment._id %>">
      <textarea name="content" rows="2" placeholder="Write a reply…" maxlength="3000" required></textarea>
      <button class="btn btn-sm" type="submit">Reply</button>
    </form>
  <% } %>

  <form method="POST" action="/<%= company.slug %>/report" style="display:inline;">
    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
    <input type="hidden" name="targetType" value="comment">
    <input type="hidden" name="targetId" value="<%= comment._id %>">
    <input type="hidden" name="reasonCode" value="INAPPROPRIATE">
    <button type="submit" class="btn btn-link small" title="Report this comment">Report</button>
  </form>
  
  <% if (replies && replies.length) { %>
    <ul class="replies" data-replies>
      <% replies.forEach(function(r){ %>
        <li class="comment-card" data-reply-id="<%= r._id %>">
          <div class="comment-header">
            <div>
              <span class="comment-author"><%= r.authorId?.fullName || 'User' %></span>
              <span class="comment-time">• <%= new Date(r.createdAt).toLocaleString() %></span>
            </div>
            <% if (
              user && (
                String(user._id) === String(r.authorId?._id || r.authorId) ||
                ['ORG_ADMIN','MODERATOR'].includes(user.role)
              )
            ) { %>
              <form method="POST"
                    action="/<%= company.slug %>/posts/<%= post._id %>/comments/<%= r._id %>/delete"
                    onsubmit="return confirm('Delete this reply?')">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                <button class="btn btn-ghost btn-sm" type="submit">Delete</button>
              </form>
            <% } %>
          </div>

          <% if (r.status === 'deleted') { %>
            <div class="comment-content"><em>(deleted)</em></div>
          <% } else { %>
            <div class="comment-content"><%- r.content %></div>
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } %>
</li>
