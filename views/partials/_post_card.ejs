<div class="post-card">
  <!-- Header -->
  <header class="post-header">
    <img
      class="post-avatar"
      src="<%= post.authorId?.avatarUrl || '/img/avatar.png' %>"
      alt="<%= post.authorId?.fullName || 'User' %>"
      loading="lazy"
    />

    <div class="post-meta">
      <div class="post-author">
        <a href="/<%= company.slug %>/profile/<%= post.authorId?._id %>">
          <%= post.authorId?.fullName || 'Unknown User' %>
        </a>
        <% if (post.authorId?.title) { %>
          <span class="post-title"> Â· <%= post.authorId.title %></span>
        <% } %>
      </div>

      <div class="post-time">
        <%= new Date(post.createdAt || post.publishedAt).toLocaleString() %>
        <% if (post.groupId && post.group) { %>
          Â· in
          <a href="/<%= company.slug %>/g/<%= post.groupId %>" class="post-group">
            <%= post.group.name %>
          </a>
        <% } %>
      </div>
    </div>
  </header>

  <!-- Body -->
  <section class="post-body">
    <% if (post.richText) { %>
      <div class="post-content"><%- post.richText %></div>
    <% } %>

    <% if (post.firstAttachmentUrl) {
         const _u = String(post.firstAttachmentUrl || '');
         const isCloudinary = _u.includes('/upload/');
         const imgSrc = isCloudinary
           ? _u.replace('/upload/', '/upload/w_900,h_600,c_fill,q_auto,f_auto/')
           : _u;
    %>
      <a href="<%= post.firstAttachmentUrl %>" target="_blank" rel="noopener noreferrer">
        <img
          class="post-image"
          src="<%= imgSrc %>"
          alt="<%= post.imageAlt || 'Post image' %>"
          loading="lazy"
        />
      </a>
    <% } %>

    <% if (post.type === 'LINK' && post.linkPreview?.url) { %>
      <div class="link-preview">
        <% if (post.linkPreview.imageUrl) { %>
          <img class="link-thumb" src="<%= post.linkPreview.imageUrl %>" alt="" loading="lazy" />
        <% } %>
        <div class="link-info">
          <div class="link-title"><%= post.linkPreview.title || post.linkPreview.url %></div>
          <div class="link-desc"><%= post.linkPreview.description || '' %></div>
          <a href="<%= post.linkPreview.url %>" target="_blank" rel="noopener noreferrer" class="link-open">
            Open link
          </a>
        </div>
      </div>
    <% } %>
  </section>

  <!-- Footer -->
  <footer class="post-footer">
    <% /* derived helpers (fallbacks if controller didn't supply) */ %>
    <%
      function __sumReactions(byType){
        try { return Object.values(byType || {}).reduce((a,b)=> a + (Number(b)||0), 0); } catch(e){ return 0; }
      }
      const __totalReactions = (typeof post.totalReactions === 'number')
        ? post.totalReactions
        : __sumReactions(post.reactionsCountByType);
      const __engRate = (typeof post.engagementRate === 'number')
        ? post.engagementRate
        : ( ((__totalReactions + (post.commentsCount||0)) / Math.max((post.viewsCount||0), 1)) * 100 );
      const __viewed = (typeof viewedPostIds !== 'undefined') && viewedPostIds && viewedPostIds.has(String(post._id));
    %>

    <!-- Metrics -->
    <div class="card-metrics">
      <span title="Unique per session views">ğŸ‘ <%= post.viewsCount || 0 %> views</span>
      <span title="All reactions (sum of types)">ğŸ‰ <%= __totalReactions %> reactions</span>
      <span title="Visible comments">ğŸ’¬ <%= post.commentsCount || 0 %> comments</span>
      <span title="(Reactions + Comments) / Views">â†—ï¸ <%= (__engRate).toFixed(1) %>% engagement</span>
      <% if (__viewed) { %>
        <span class="muted">ğŸ‘ Viewed</span>
      <% } %>
    </div>

    <!-- Reactions -->
    <div class="post-reactions reactions" data-react-scope data-target-type="post" data-target-id="<%= post._id %>">
      <%- include('./_reactions_bar', { company, user, post }) %>
    </div>

    <!-- Actions -->
    <div class="post-actions admin-links">
      <a class="btn-link" href="/<%= company.slug %>/posts/<%= post._id %>">Open</a>

      <% if (user && (String(user._id) === String(post.authorId?._id) || ['MODERATOR','ORG_ADMIN'].includes(user.role))) { %>
        <form action="/<%= company.slug %>/posts/<%= post._id %>/delete" method="POST">
          <button class="btn-link danger" onclick="return confirm('Delete this post?')" aria-label="Delete post">
            Delete
          </button>
        </form>
      <% } %>
    </div>
  </footer>
</div>
