<%
function timeAgo(date) {
  const seconds = Math.floor((Date.now() - date) / 1000);
  const intervals = [
    { label: 'y', secs: 31536000 },
    { label: 'm', secs: 2592000 },
    { label: 'd', secs: 86400 },
    { label: 'h', secs: 3600 },
    { label: 'm', secs: 60 },
  ];
  for (let i of intervals) {
    const v = Math.floor(seconds / i.secs);
    if (v >= 1) return `${v}${i.label} ago`;
  }
  return "Just now";
}
%>

<% (function(){ %>
  <!-- views/partials/_post_card.ejs -->
  
  <%
    // ---- top-level derivations (compute once) ----
    const isCompact = typeof compact !== 'undefined' && compact;
  
    const maxLength = 200;
    const plainText = (post.richText || '').replace(/<[^>]*>/g, ''); // strip HTML
    const shortText = plainText.length > maxLength ? plainText.slice(0, maxLength) + '‚Ä¶' : plainText;
  
    const _vals = Object.values(post.reactionsCountByType || {});
    const __totalReactions = (typeof post.totalReactions === 'number')
      ? post.totalReactions
      : _vals.reduce((a,b) => a + (Number(b) || 0), 0);
    const __views = Number(post.viewsCount || 0);
    const __comments = Number(post.commentsCount || 0);
    const __engRate = (typeof post.engagementRate === 'number')
      ? post.engagementRate
      : (((__totalReactions + __comments) / Math.max(__views, 1)) * 100);
    const __viewed = (typeof viewedPostIds !== 'undefined') && viewedPostIds && viewedPostIds.has(String(post._id));
  
    const tsRaw = post.createdAt || post.publishedAt || post.updatedAt || Date.now();
    const ts = new Date(tsRaw);
    const inGroup = !!(post.groupId && post.group);
  %>

  <%
    // Safe autolink for plain text (used in compact excerpt)
    function autolink(txt=''){
      const esc = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      const urlRx = /(https?:\/\/[^\s<]+)/g;
      return esc(txt).replace(urlRx, m => `<a class="inline-link" href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);
    }
  %>

  
  <article class="post-card"
           data-post-id="<%= post._id %>"
           data-href="/<%= company.slug %>/posts/<%= post._id %>"
           aria-labelledby="post-title-<%= post._id %>">
  
    <!-- Header -->
    <header class="post-header" style="margin-bottom:15px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <!-- LEFT: Avatar + meta -->
      <div class="post-header-left" style="display:flex; align-items:center; gap:10px;">
          <a class="post-avatar-link" href="/<%= company.slug %>/profile/<%= post.authorId?._id %>">
            <%
              const _fullName = post.authorId?.fullName || '';
              const _nameParts = _fullName.trim().split(/\s+/);
              let _initials = '';
              if (_nameParts.length === 1 && _nameParts[0]) {
                _initials = _nameParts[0].slice(0, 2).toUpperCase();
              } else if (_nameParts.length > 1) {
                _initials =
                  (_nameParts[0][0] || '').toUpperCase() +
                  (_nameParts[1][0] || '').toUpperCase();
              }
              const _avatarUrl = post.authorId?.avatarUrl;  // usually your LinkedIn-synced photo
            %>
  
            <% if (_avatarUrl) { %>
              <!-- Use LinkedIn / stored avatar when available -->
              <img
                class="post-avatar"
                src="<%= _avatarUrl %>"
                alt="<%= _fullName || 'User' %>"
                loading="lazy"
                decoding="async"
                onerror="this.src='/img/avatar.png'; this.onerror=null;"
              />
            <% } else { %>
              <!-- Fallback: initials avatar -->
              <div
                class="post-avatar initials-avatar"
                aria-hidden="true"
                style="
                  width:40px;
                  height:40px;
                  border-radius:50%;
                  display:flex;
                  align-items:center;
                  justify-content:center;
                  background:#4a5568;
                  color:#fff;
                  font-weight:600;
                  text-transform:uppercase;
                  font-size:0.9rem;
                "
              >
                <%= _initials || '?' %>
              </div>
            <% } %>
          </a>  
  
        <div class="post-meta">
          <div class="post-author">
            <a id="post-title-<%= post._id %>" href="/<%= company.slug %>/profile/<%= post.authorId?._id %>" style="font-weight:bold;">
              <%= post.authorId?.fullName || 'Unknown User' %>
            </a>
            <% if (post.type === 'ANNOUNCEMENT') { %>
              <span class="badge" style="margin-left:6px;">üì¢ Announcement</span>
              <% if (post.isPinned) { %><span class="badge" title="Pinned to top" style="margin-left:4px;">üìå Pinned</span><% } %>
            <% } %>
          </div>
  
          <div class="post-time">
            <time datetime="<%= ts.toISOString() %>"><%= timeAgo(ts) %></time>
            <% if (inGroup) { %>
              ¬∑ in <a href="/<%= company.slug %>/g/<%= post.groupId %>" class="post-group"><%= post.group?.name %></a>
            <% } %>
          </div>
        </div>
      </div>
  
      <!-- RIGHT: Actions -->
      <div class="post-header-actions" style="display:flex; align-items:center; gap:10px;">
        <% if (post.status === 'DRAFT' && String(user._id) === String(post.authorId?._id || post.authorId)) { %>
          <a class="icon-btn" title="Edit draft" href="/<%= company.slug %>/posts/<%= post._id %>/edit">‚úèÔ∏è</a>
        <% } %>
        
        <% if (user && (String(user._id) === String(post.authorId?._id) || ['MODERATOR','ORG_ADMIN'].includes(user.role))) { %>
          <form action="/<%= company.slug %>/posts/<%= post._id %>/delete" method="POST" onsubmit="return confirm('Delete this post?');">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            <button type="submit" title="Delete post" class="icon-btn danger" aria-label="Delete post">üóëÔ∏è</button>
          </form>
        <% } %>
  
        <form method="POST" action="/<%= company.slug %>/report" style="display:inline;">
          <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
          <input type="hidden" name="targetType" value="post">
          <input type="hidden" name="targetId" value="<%= post._id %>">
          <input type="hidden" name="reasonCode" value="INAPPROPRIATE">
          <button type="submit" title="Report post" class="icon-btn" aria-label="Report post">üö©</button>
        </form>
      </div>
    </header>
  
    <!-- Post Body -->
    <section class="post-body">
      <% if (post.type === 'POLL' && post.poll && Array.isArray(post.poll.questions)) { %>
        <%- include('./_post_card_poll', { company, user, post }) %>
      <% } else { %>

      <% /* üîπ Announcement heading (optional) */ %>
      <% if (post.type === 'ANNOUNCEMENT' && post.title) { %>
        <h3 class="post-announcement-title" style="margin:0 0 8px;font-size:1.05rem;font-weight:600;">
          <%= post.title %>
        </h3>
      <% } %>

      <% /* Content (sanitized HTML); compact shows excerpt */ %>
      <% if (post.richText) { %>
        <% if (isCompact) { %>
          <div class="post-content compact"><%- autolink(shortText) %></div>
        <% } else { %>
          <div class="post-content"><%- post.richText %></div>
        <% } %>
      <% } %>
     
  
      <%
      // Prefer: detail view ‚Üí full attachments; feed/compact ‚Üí _thumbs; fallback ‚Üí firstAttachmentUrl
      // üîπ ANNOUNCEMENT hero image
      const heroUrl = (post.type === 'ANNOUNCEMENT' && post.coverImageUrl)
        ? String(post.coverImageUrl)
        : null;

      let imgs = [];
      if (Array.isArray(post.attachments) && post.attachments.length) {
        imgs = post.attachments.map(a => ({ storageUrl: a.storageUrl || a }));
      } else if (Array.isArray(post._thumbs) && post._thumbs.length) {
        imgs = post._thumbs.map(u => ({ storageUrl: u }));
      } else if (post.firstAttachmentUrl) {
        imgs = [{ storageUrl: post.firstAttachmentUrl }];
      }

      // üîπ If we have a hero image, avoid duplicating it in the grid
      if (heroUrl && imgs.length) {
        imgs = imgs.filter(a => String(a.storageUrl) !== heroUrl);
      }

      const count = imgs.length;
    %>

    <% /* üîπ ANNOUNCEMENT hero block */ %>
    <% if (heroUrl) { %>
      <div class="announcement-hero" style="margin:0 0 10px;">
        <img
          src="<%= heroUrl %>"
          alt="<%= post.imageAlt || 'Announcement image' %>"
          class="announcement-hero-img"
          style="max-width:100%;height:auto;border-radius:10px;display:block;"
          loading="lazy"
          decoding="async"
        >
      </div>
    <% } %>


      <% if (count > 0) { %>
        <%
          const gridClass =
            (count === 1) ? 'media-grid--1' :
            (count === 2) ? 'media-grid--2' :
            (count === 3) ? 'media-grid--3' :
            (count === 4) ? 'media-grid--4' :
            (count === 5) ? 'media-grid--5' :
            'media-grid--many';
        %>

        <div class="media-grid <%= gridClass %>" data-lightbox-group="<%= post._id %>">
          <% imgs.forEach(function(att, i){
              const u = String(att.storageUrl || '');
              const isC = u.includes('/upload/');
              const thumb = isC
                ? u.replace('/upload/', '/upload/w_240,h_240,c_fill,q_auto,f_auto/')
                : u;
              const full = isC
                ? u.replace('/upload/', '/upload/w_1600,h_1200,c_fit,q_auto,f_auto/')
                : u;
              const extra = (post.attachmentsCount || count) - 9; // respects true count if denorm exists
          %>
            <% if (i < 9) { %>
              <div class="media-thumb-wrap">
                <img
                  src="<%= thumb %>"
                  data-full="<%= full %>"
                  alt="<%= post.imageAlt || 'Attached image' %>"
                  class="media-thumb"
                  loading="lazy"
                  decoding="async"
                  onclick="openLightbox(event, this)"
                >
                <% if (i === 8 && extra > 0) { %>
                  <div class="multi-overlay">+<%= extra %></div>
                <% } %>
              </div>
            <% } %>
          <% }) %>
        </div>
      <% } %>

  
  
      <% /* Link preview */ %>
      <% if (post.type === 'LINK' && post.linkPreview?.url) { 
        const url      = String(post.linkPreview.url || '');
        const host     = (()=>{ try { return new URL(url).hostname.replace(/^www\./,''); } catch(_e){ return url; } })();
        const title    = post.linkPreview.title || host;
        const desc     = post.linkPreview.description || '';
        const imgUrl   = post.linkPreview.imageUrl || ''; // may be empty
        const isCloud  = imgUrl.includes('/upload/');
        const thumb    = imgUrl
           ? (isCloud ? imgUrl.replace('/upload/','/upload/w_640,h_360,c_fill,q_auto,f_auto/') : imgUrl)
           : ''; // fallback handled in markup
   %>
   <a class="link-preview <%= isCompact ? 'lp--compact' : 'lp--full' %>"
    style="margin-top:10px; margin-bottom:8px;"
        href="<%= url %>"
        target="_blank"
        rel="noopener noreferrer"
        aria-label="Open linked page: <%= title %>">
        
       <% /* IMAGE (optional) */ %>
       <% if (!isCompact) { %>
         <div class="lp-media">
           <% if (thumb) { %>
             <img class="lp-img" src="<%= thumb %>" alt="" loading="lazy" decoding="async">
           <% } else { %>
             <div class="lp-img lp-img--fallback">üîó</div>
           <% } %>
         </div>
       <% } else { %>
         <% /* compact: small square thumb at left */ %>
         <div class="lp-media lp-media--sm">
           <% if (thumb) { %>
             <img class="lp-img lp-img--sm" src="<%= thumb %>" alt="" loading="lazy" decoding="async">
           <% } else { %>
             <div class="lp-img lp-img--sm lp-img--fallback">üîó</div>
           <% } %>
         </div>
       <% } %>
   
       <% /* TEXT META */ %>
       <div class="lp-body">
         <div class="lp-host">
           <span class="lp-fav" aria-hidden="true">üåê</span>
           <span class="lp-hostname"><%= host %></span>
         </div>
         <div class="lp-title"><%= title %></div>
         <% if (!isCompact && desc) { %>
           <div class="lp-desc"><%= desc %></div>
         <% } %>
       </div>
     </a>
   <% } %>
   
  
      <% } /* end non-poll */ %>
    </section>
  
    <!-- Post Footer -->
    <footer class="post-footer">
      <div class="post-reactions reactions" data-react-scope data-target-type="post" data-target-id="<%= post._id %>">
        <%- include('./_reactions_bar', { company, user, post }) %>
      </div>
    </footer>
  </article>
  
  <script>
    // Lightweight "time ago" enhancer (kept simple)
    (function(){
      var card = document.currentScript.previousElementSibling;
      if (!card) return;
      var t = card.querySelector('.post-time time');
      if (!t) return;
      // You can plug your relative-time code here later if needed.
    })();
  </script>
  
  <script>
    (function(){
      // Card click ‚Üí open detail (ignore interactive elements & polls)
      document.addEventListener('click', function(e){
        const interactive = e.target.closest(
          'a, button, input, textarea, select, label, summary, details, .media-thumb, .media-thumb-wrap, .link-preview'
        );

        if (interactive || e.target.closest('.poll-form') || e.target.closest('.poll-result-q')) return;
        const card = e.target.closest('.post-card[data-href]');
        if (!card) return;
        const url = card.getAttribute('data-href');
        if (url) window.location.href = url;
      }, {passive:true});

  
      // Carousel (if present in this card)
      const card = document.currentScript.previousElementSibling;
      if (!card) return;
      const root = card.querySelector('.gallery');
      if (!root) return;
  
      const track = root.querySelector('.g-track');
      const slides = Array.from(root.querySelectorAll('.g-slide'));
      const prev = root.querySelector('.g-prev');
      const next = root.querySelector('.g-next');
      if (!track || !slides.length) return;
  
      let i = 0;
      function go(k){
        i = (k + slides.length) % slides.length;
        track.style.transform = 'translateX(' + (-i * 100) + '%)';
      }
      prev && prev.addEventListener('click', ()=>go(i-1));
      next && next.addEventListener('click', ()=>go(i+1));
  
      root.tabIndex = 0;
      root.addEventListener('keydown', (e)=>{
        if (e.key === 'ArrowLeft') go(i-1);
        if (e.key === 'ArrowRight') go(i+1);
      });
  
      let sx=0, dx=0;
      root.addEventListener('touchstart', e=>{ sx = e.touches[0].clientX; dx=0; }, {passive:true});
      root.addEventListener('touchmove', e=>{ dx = e.touches[0].clientX - sx; }, {passive:true});
      root.addEventListener('touchend', ()=>{ if (Math.abs(dx) > 40) go(i + (dx<0 ? 1 : -1)); });
  
      go(0);
    })();
  </script>
  
  <% })(); %>
  
  <script>
    (function(){
      // Linkify plain text nodes inside non-compact .post-content without breaking existing HTML
      const card = document.currentScript.previousElementSibling;
      if (!card) return;
      const content = card.querySelector('.post-content:not(.compact)');
      if (!content) return;
    
      const urlRx = /(https?:\/\/[^\s<]+)/g;
    
      function linkifyNode(node){
        const parts = node.textContent.split(urlRx);
        if (parts.length === 1) return; // no URLs
        const frag = document.createDocumentFragment();
        for (let i=0; i<parts.length; i++){
          if (i % 2 === 0) {
            frag.appendChild(document.createTextNode(parts[i]));
          } else {
            const a = document.createElement('a');
            a.href = parts[i];
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.className = 'inline-link';
            a.textContent = parts[i];
            frag.appendChild(a);
          }
        }
        node.replaceWith(frag);
      }
    
      // Walk text nodes (skip inside existing links)
      const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, {
        acceptNode: (n) => n.parentElement && n.parentElement.closest('a') ? NodeFilter.FILTER_REJECT : NodeFilter.FILTER_ACCEPT
      });
      const texts = [];
      while (walker.nextNode()) texts.push(walker.currentNode);
      texts.forEach(linkifyNode);
    })();
    </script>
    