<!-- views/partials/_post_card.ejs -->
<article class="post-card" data-post-id="<%= post._id %>" aria-labelledby="post-title-<%= post._id %>">
  
  <!-- Header -->
  <header class="post-header">
    <a class="post-avatar-link" href="/<%= company.slug %>/profile/<%= post.authorId?._id %>" aria-label="<%= (post.authorId?.fullName || 'User') + ' profile' %>">
      <img
        class="post-avatar"
        src="<%= post.authorId?.avatarUrl || '/img/avatar.png' %>"
        alt=""
        loading="lazy"
        decoding="async"
        onerror="this.src='/img/avatar.png'; this.onerror=null;"
      />
    </a>

    <div class="post-meta">
      <div class="post-author">
        <a id="post-title-<%= post._id %>" href="/<%= company.slug %>/profile/<%= post.authorId?._id %>">
          <%= post.authorId?.fullName || 'Unknown User' %>
        </a>
        <% if (post.authorId?.title) { %>
          <span class="post-title"> · <%= post.authorId.title %></span>
        <% } %>
      </div>

      <div class="post-time" data-ts="<%= (post.createdAt || post.publishedAt || post.updatedAt || new Date()).toISOString ? (post.createdAt || post.publishedAt || post.updatedAt) : new Date(post.createdAt || post.publishedAt || Date.now()) %>">
        <% 
          const _ts = new Date(post.createdAt || post.publishedAt || Date.now());
          const _inGroup = !!(post.groupId && post.group);
        %>
        <time datetime="<%= _ts.toISOString() %>"><%= _ts.toLocaleString() %></time>
        <% if (_inGroup) { %>
          · in
          <a href="/<%= company.slug %>/g/<%= post.groupId %>" class="post-group"><%= post.group?.name %></a>
        <% } %>
        <% if (post.type) { %>
          · <span class="muted" title="Post type"><%= String(post.type).toLowerCase() %></span>
        <% } %>
      </div>
    </div>
  </header>

  <!-- Body -->
  <section class="post-body">
    <% /* Assume post.richText is sanitized HTML. */ %>
    <% if (post.richText) { %>
      <div class="post-content"><%- post.richText %></div>
    <% } %>

    <% /* First attachment (image) with Cloudinary smart transform if relevant */ %>
    <% if (post.firstAttachmentUrl) {
         const _u = String(post.firstAttachmentUrl || '');
         const isCloudinary = _u.includes('/upload/');
         const imgSrc = isCloudinary
           ? _u.replace('/upload/', '/upload/w_1200,h_800,c_fill,q_auto,f_auto/')
           : _u;
    %>
      <a href="<%= post.firstAttachmentUrl %>" target="_blank" rel="noopener noreferrer" class="post-image-link" aria-label="Open attachment in a new tab">
        <img
          class="post-image"
          src="<%= imgSrc %>"
          alt="<%= post.imageAlt || 'Attached image' %>"
          loading="lazy"
          decoding="async"
          onerror="this.closest('a').removeAttribute('href'); this.alt='Image failed to load';"
        />
      </a>
    <% } %>

    <% /* Link preview for LINK posts (thumb optional) */ %>
    <% if (post.type === 'LINK' && post.linkPreview?.url) { %>
      <div class="link-preview" role="group" aria-label="Link preview">
        <% if (post.linkPreview.imageUrl) { %>
          <img class="link-thumb" src="<%= post.linkPreview.imageUrl %>" alt="" loading="lazy" decoding="async" />
        <% } %>
        <div class="link-info">
          <div class="link-title"><%= post.linkPreview.title || post.linkPreview.url %></div>
          <div class="link-desc"><%= post.linkPreview.description || '' %></div>
          <a href="<%= post.linkPreview.url %>" target="_blank" rel="noopener noreferrer" class="link-open" aria-label="Open linked page">
            Open link
          </a>
        </div>
      </div>
    <% } %>
  </section>

  <!-- Footer -->
  <footer class="post-footer">
    <% /* Derived helpers & safe fallbacks */ %>
    <%
      function __sumReactions(byType){
        try { return Object.values(byType || {}).reduce((a,b)=> a + (Number(b)||0), 0); } catch(e){ return 0; }
      }
      const __totalReactions = (typeof post.totalReactions === 'number')
        ? post.totalReactions
        : __sumReactions(post.reactionsCountByType);
      const __views = Number(post.viewsCount || 0);
      const __comments = Number(post.commentsCount || 0);
      const __engRate = (typeof post.engagementRate === 'number')
        ? post.engagementRate
        : (((__totalReactions + __comments) / Math.max(__views, 1)) * 100);
      const __viewed = (typeof viewedPostIds !== 'undefined') && viewedPostIds && viewedPostIds.has(String(post._id));
    %>

    <!-- Metrics -->
    <div class="card-metrics" aria-label="Post metrics">
      <span title="Unique per session views">👁 <span data-count="views"><%= __views %></span> views</span>
      <span title="All reactions (sum of types)">🎉 <span data-count="reactions"><%= __totalReactions %></span> reactions</span>
      <span title="Visible comments">💬 <span data-count="comments"><%= __comments %></span> comments</span>
      <span title="(Reactions + Comments) / Views">↗️ <span data-rate="engagement"><%= __engRate.toFixed(1) %></span>% engagement</span>
      <% if (__viewed) { %>
        <span class="muted" aria-label="You viewed this post">👁 Viewed</span>
      <% } %>
    </div>

    <!-- Reactions -->
    <div class="post-reactions reactions" data-react-scope data-target-type="post" data-target-id="<%= post._id %>">
      <%- include('./_reactions_bar', { company, user, post }) %>
    </div>

    <!-- Actions -->
    <div class="post-actions admin-links">
      <a class="btn-link" href="/<%= company.slug %>/posts/<%= post._id %>" aria-label="Open post">Open</a>

      <% if (user && (String(user._id) === String(post.authorId?._id) || ['MODERATOR','ORG_ADMIN'].includes(user.role))) { %>
        <form action="/<%= company.slug %>/posts/<%= post._id %>/delete" method="POST" onsubmit="return confirm('Delete this post?');" aria-label="Delete post form">
          <button class="btn-link danger" type="submit">Delete</button>
        </form>
      <% } %>
    </div>

    <!-- Quick report -->
    <form method="POST" action="/<%= company.slug %>/report" style="display:inline;" aria-label="Report this post">
      <input type="hidden" name="targetType" value="post">
      <input type="hidden" name="targetId" value="<%= post._id %>">
      <input type="hidden" name="reasonCode" value="INAPPROPRIATE">
      <button type="submit" class="btn btn-ghost small" title="Report this post" aria-label="Report this post">Report</button>
    </form>
  </footer>
</article>

<script>
  // Lightweight "time ago" enhancer + safe fallbacks
  (function(){
    var wrap = document.currentScript && document.currentScript.previousElementSibling?.querySelector?.('.post-time time');
    if (!wrap) return;
    try {
      var dt = new Date(wrap.getAttribute('datetime'));
      var diff = (Date.now() - dt.getTime()) / 1000; // seconds
      var out;
      if (diff < 60) out = 'just now';
      else if (diff < 3600) out = Math.floor(diff/60) + 'm';
      else if (diff < 86400) out = Math.floor(diff/3600) + 'h';
      else if (diff < 604800) out = Math.floor(diff/86400) + 'd';
      else out = dt.toLocaleDateString();
      wrap.textContent = out;
      wrap.setAttribute('title', dt.toLocaleString());
    } catch(e){}
  })();
</script>
