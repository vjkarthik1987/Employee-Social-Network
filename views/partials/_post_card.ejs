<!-- views/partials/_post_card.ejs -->
<div class="card post-card" style="margin-bottom:1rem;">
  <!-- Header -->
  <div class="card-header" style="display:flex;align-items:center;gap:.6rem;">
    <img src="<%= post.authorId?.avatarUrl || '/img/avatar.png' %>"
         alt="<%= post.authorId?.fullName || 'User' %>"
         style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
    <div>
      <div style="font-weight:600;">
        <a href="/<%= company.slug %>/profile/<%= post.authorId?._id %>" style="text-decoration:none;color:inherit;">
          <%= post.authorId?.fullName || 'Unknown User' %>
        </a>
        <% if (post.authorId?.title) { %>
          <span style="color:#888;font-weight:400;"> ¬∑ <%= post.authorId.title %></span>
        <% } %>
      </div>
      <div style="font-size:.82rem;color:#777;">
        <%= new Date(post.createdAt || post.publishedAt).toLocaleString() %>
        <% if (post.groupId && post.group) { %> ¬∑ in
          <a href="/<%= company.slug %>/g/<%= post.groupId %>" style="color:#666;"><%= post.group.name %></a>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="card-body">
    <!-- Text content (always show, even if image post) -->
    <% if (post.richText) { %>
      <div class="post-content" style="white-space:pre-wrap;"><%- post.richText %></div>
    <% } %>

    <!-- Image thumbnail (Cloudinary or local) -->
    <% if (post.firstAttachmentUrl) { 
        const _u = String(post.firstAttachmentUrl || '');
        const isCloudinary = _u.includes('/upload/');
        const imgSrc = isCloudinary
          ? _u.replace('/upload/', '/upload/w_900,h_600,c_fill,q_auto,f_auto/')
          : _u;
    %>
      <a href="<%= post.firstAttachmentUrl %>" target="_blank" rel="noopener">
        <img
          src="<%= imgSrc %>"
          alt="<%= post.imageAlt || 'post image' %>"
          style="width:100%;height:auto;border-radius:10px;margin-top:.6rem;display:block;" />
      </a>
    <% } %>

    <!-- LINK preview (optional) -->
    <% if (post.type === 'LINK' && post.linkPreview && post.linkPreview.url) { %>
      <div class="card" style="margin-top:.6rem;">
        <div class="card-body" style="display:flex;gap:.8rem;align-items:flex-start;">
          <% if (post.linkPreview.imageUrl) { %>
            <img src="<%= post.linkPreview.imageUrl %>"
                 alt=""
                 style="width:96px;height:96px;object-fit:cover;border-radius:6px;">
          <% } %>
          <div>
            <div style="font-weight:600;margin-bottom:.2rem;"><%= post.linkPreview.title || post.linkPreview.url %></div>
            <div style="color:#666;font-size:.9rem;"><%= post.linkPreview.description || '' %></div>
            <div style="margin-top:.3rem;">
              <a href="<%= post.linkPreview.url %>" target="_blank" rel="noopener">Open link</a>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  </div>

  <!-- Footer: counts + actions -->
  <div class="card-footer" style="display:flex;justify-content:space-between;align-items:center;">
    <small style="color:#666;">
      <span id="reactions-count">
        <%
          const rc = post.reactionsCountByType || {};
          const totalReactions =
            (rc.LIKE||0) + (rc.HEART||0) + (rc.CELEBRATE||0) +
            (rc.SUPPORT||0) + (rc.LAUGH||0) + (rc.INSIGHTFUL||0) + (rc.THANKS||0);
        %>
        <%= totalReactions %>
      </span> reactions ‚Ä¢
      <span id="comments-count"><%= post.commentsCount || 0 %></span> comments
    </small>

    <div style="display:flex;gap:.75rem;align-items:center;">
      <!-- Open -->
      <a class="btn btn-link" href="/<%= company.slug %>/posts/<%= post._id %>">Open</a>

      <!-- Delete -->
      <% if (user && (String(user._id) === String(post.authorId?._id) || user.role === 'MODERATOR' || user.role === 'ORG_ADMIN')) { %>
        <form action="/<%= company.slug %>/posts/<%= post._id %>/delete" method="POST" style="margin:0;">
          <button class="btn btn-link" style="color:#c00;" onclick="return confirm('Delete this post?')">Delete</button>
        </form>
      <% } %>
    </div>
  </div>

  <!-- Reactions bar -->
  <div class="card-footer" style="display:flex;gap:.5rem;">
    <form action="/<%= company.slug %>/posts/<%= post._id %>/react" method="POST" class="inline">
      <button data-react="LIKE" type="button">üëç</button>
      <button data-react="HEART" type="button">‚ù§Ô∏è</button>
      <button data-react="CELEBRATE" type="button">üéâ</button>
    </form>
  </div>
</div>
