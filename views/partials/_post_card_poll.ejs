<%
const userHasVoted = Array.isArray(post.poll?.voterIds) && post.poll.voterIds.some(id => String(id) === String(user?._id));
const showResults  = post.poll?.isClosed || userHasVoted;
const ts = new Date(post.createdAt || post.publishedAt || post.updatedAt || Date.now());
%>

<article class="post-card poll" data-post-id="<%= post._id %>">
  <header class="post-header poll-header">
    <div class="post-author">
      <a href="/<%= company.slug %>/profile/<%= post.authorId?._id %>"><%= post.authorId?.fullName || 'User' %></a>
      <span class="badge badge-pill">Poll</span>
      <% if (post.poll?.isClosed) { %>
        <span class="badge badge-muted badge-pill">Closed</span>
      <% } %>
    </div>
    <div class="post-meta">
      <time datetime="<%= ts.toISOString() %>"><%= ts.toLocaleString() %></time>
      <% if (post.groupId && post.group) { %>
        · in <a href="/<%= company.slug %>/g/<%= post.groupId %>"><%= post.group?.name %></a>
      <% } %>
    </div>
  </header>

  <div class="poll-card-body">
    <% if (post.poll?.title) { %>
      <h3 class="poll-title"><%= post.poll.title %></h3>
    <% } %>

    <% if (!showResults) { %>
      <!-- Voting form -->
      <form class="poll-form" onsubmit="return submitPoll_<%= post._id %>(this)">
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

        <% (post.poll?.questions || []).forEach(function(q, idx){ %>
          <section class="poll-question">
            <div class="poll-question-header">
              <div class="poll-question-index">Q<%= idx + 1 %></div>
              <div class="poll-question-text"><%= q.text %></div>
              <% if (q.multiSelect) { %>
                <span class="poll-question-tag">Multiple choice</span>
              <% } %>
            </div>

            <div class="poll-options">
              <% (q.options || []).forEach(function(o){ %>
                <label class="poll-option">
                  <span class="poll-option-input">
                    <input
                      type="<%= q.multiSelect ? 'checkbox' : 'radio' %>"
                      name="q-<%= q.qid %>"
                      value="<%= o.oid %>"
                      <%= q.multiSelect ? '' : 'required' %>
                    >
                    <span class="poll-custom-indicator"></span>
                  </span>
                  <span class="poll-option-label"><%= o.label %></span>
                </label>
              <% }) %>
            </div>
          </section>
        <% }) %>

        <footer class="poll-actions">
          <button type="submit" class="btn btn-primary poll-submit">Submit vote</button>
          <div class="poll-stats">
            <span class="poll-participants">
              <strong><%= Number(post.poll?.totalParticipants || 0) %></strong> participants
            </span>
            <% if (!post.poll?.isClosed) { %>
              <span class="poll-hint">You’ll see results after you vote.</span>
            <% } %>
          </div>
          <% if (user && ['MODERATOR','ORG_ADMIN'].includes(user.role)) { %>
            <button type="button" class="btn btn-ghost poll-close-btn" onclick="return closePoll_<%= post._id %>(this)">
              Close poll
            </button>
          <% } %>
        </footer>
      </form>

    <% } else { %>
      <!-- Results mode -->
      <div class="poll-results">
        <% (post.poll?.questions || []).forEach(function(q, idx){
             const total = (q.options||[]).reduce((n,o)=>n+(o.votesCount||0),0) || 0; %>

          <section class="poll-question poll-question-results">
            <div class="poll-question-header">
              <div class="poll-question-index">Q<%= idx + 1 %></div>
              <div class="poll-question-text"><%= q.text %></div>
              <% if (q.multiSelect) { %>
                <span class="poll-question-tag">Multiple choice</span>
              <% } %>
            </div>

            <div class="poll-options poll-options-results">
              <% (q.options || []).forEach(function(opt){
                   const votes = Number(opt.votesCount||0);
                   const pct = total ? Math.round((votes/total)*100) : 0; %>

                <div class="poll-option poll-option-result">
                  <div class="poll-option-top">
                    <span class="poll-option-label"><%= opt.label %></span>
                    <span class="poll-option-value">
                      <%= votes %> vote<%= votes === 1 ? '' : 's' %> · <%= pct %>%
                    </span>
                  </div>
                  <div class="poll-bar">
                    <div class="poll-bar-fill" style="width:<%= pct %>%"></div>
                  </div>
                </div>
              <% }) %>
            </div>

            <div class="poll-question-footer">
              <span class="fineprint">Total votes on this question: <%= total %></span>
            </div>
          </section>
        <% }) %>

        <footer class="poll-footer-summary">
          <span class="fineprint">
            Participants: <strong><%= Number(post.poll?.totalParticipants || 0) %></strong>
            <% if (post.poll?.isClosed) { %> · Poll closed<% } else { %> · Voting open<% } %>
          </span>
        </footer>
      </div>
    <% } %>
  </div>
</article>

<script>
async function submitPoll_<%= post._id %>(form){
  const card = form.closest('.post-card');
  const postId = card?.getAttribute('data-post-id');
  if(!postId) return false;
  const ORG = "<%= company.slug %>";
  const CSRF = form.querySelector('input[name="_csrf"]')?.value || '';

  const answers = [];
  <% (post.poll?.questions || []).forEach(function(q){ %>
    (function(){
      const name = "q-<%= q.qid %>";
      const nodes = form.querySelectorAll('input[name="'+name+'"]');
      if (!nodes || !nodes.length) return;
      const multi = <%= !!q.multiSelect %>;
      if (multi) {
        nodes.forEach(n => { if (n.checked) answers.push({ qid: "<%= q.qid %>", oid: n.value }); });
      } else {
        const chosen = form.querySelector('input[name="'+name+'"]:checked');
        if (chosen) answers.push({ qid: "<%= q.qid %>", oid: chosen.value });
      }
    })();
  <% }); %>

  if (!answers.length) {
    alert('Please select an option.');
    return false;
  }

  const btn = form.querySelector('button[type="submit"]');
  if (btn){ btn.disabled = true; btn.textContent='Submitting…'; }

  try{
    const res = await fetch(`/${ORG}/api/polls/${postId}/submit`,{
      method:'POST',
      headers: {
        'Content-Type':'application/json',
        'Accept':'application/json',
        'CSRF-Token': CSRF
      },
      body: JSON.stringify({ answers, _csrf: CSRF })
    });
    const data = await res.json();
    if(!data.ok){
      alert(data.error || 'Failed to submit');
      if (btn){ btn.disabled=false; btn.textContent='Submit vote'; }
      return false;
    }
    location.reload();
  }catch(err){
    console.error(err);
    alert('Network error. Try again.');
    if (btn){ btn.disabled=false; btn.textContent='Submit vote'; }
  }
  return false;
}

async function closePoll_<%= post._id %>(btn){
  const ORG = "<%= company.slug %>";
  btn.disabled = true;
  btn.textContent = 'Closing…';
  try{
    const res = await fetch(`/${ORG}/api/polls/<%= post._id %>/close`, {
      method:'POST',
      headers:{
        'Accept':'application/json',
        'Content-Type':'application/json',
        'CSRF-Token':'<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>'
      }
    });
    const data = await res.json();
    if(!data.ok){
      alert(data.error || 'Failed to close');
      btn.disabled=false;
      btn.textContent='Close poll';
      return false;
    }
    location.reload();
  }catch(e){
    console.error(e);
    alert('Network error');
    btn.disabled=false;
    btn.textContent='Close poll';
  }
  return false;
}
</script>
