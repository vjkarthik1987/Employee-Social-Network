<% layout('layouts/_layout') %>

<div class="wrap" style="max-width:720px;">
  <p class="fineprint">
    <a href="/<%= company.slug %>/newsletters/<%= newsletter.slug %>">&larr; Back to <%= newsletter.name %></a>
  </p>

  <h1 class="h2">
    <%= edition.title || ('Issue #' + edition.number) %>
  </h1>
  <% if (edition.subtitle) { %>
    <p class="sub"><%= edition.subtitle %></p>
  <% } %>

  <p class="fineprint">
    Issue #<%= edition.number %> · <%= edition.status %>
    <% if (edition.publishedAt) { %>
      · Published <%= new Date(edition.publishedAt).toLocaleString() %>
    <% } %>
  </p>

  <% if (canEdit) { %>
    <div style="margin:8px 0 16px;">
      <% if (edition.status !== 'PUBLISHED' && canPublish) { %>
        <form method="POST" action="/<%= company.slug %>/newsletters/<%= newsletter.slug %>/editions/<%= edition.number %>/publish" style="display:inline-block;margin-right:8px;">
          <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
          <button type="submit" class="btn btn-primary btn-sm">
            Publish edition
          </button>
        </form>
      <% } %>
      <% if (edition.status === 'PUBLISHED') { %>
        <span class="fineprint">This edition is published and read-only for most users.</span>
      <% } %>
    </div>
  <% } %>


  <% if (canEdit && edition.status !== 'PUBLISHED') { %>
    <section style="margin:16px 0 24px;padding:12px 16px;border-radius:8px;background:#f5f5f7;">
      <h2 class="h4" style="margin-top:0;">Add content to this edition</h2>

      <!-- Add internal post -->
      <div style="margin-bottom:12px;">
        <h3 class="h5" style="margin-bottom:4px;">From internal post</h3>
        <form method="POST" action="/<%= company.slug %>/newsletters/<%= newsletter.slug %>/editions/<%= edition.number %>/items/post" style="display:flex;flex-direction:column;gap:8px;max-width:520px;">
          <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
          <label style="display:flex;flex-direction:column;gap:4px;">
            <span class="fineprint">Pick a recent post</span>
            <select name="postId" class="input">
              <option value="">-- Select a post --</option>
              <% (recentPosts || []).forEach(p => { %>
                <option value="<%= p._id %>">
                  [<%= p.type %>] <%= p.title %>
                </option>
              <% }); %>
            </select>
          </label>
          <label style="display:flex;flex-direction:column;gap:4px;">
            <span class="fineprint">Optional highlight / why this matters</span>
            <textarea name="highlight" class="input" rows="2"></textarea>
          </label>
          <button type="submit" class="btn btn-sm btn-primary">Add post</button>
        </form>
      </div>

      <!-- Add external article (AI) -->
      <div>
        <h3 class="h5" style="margin-bottom:4px;">From external article (AI summarized)</h3>
        <form method="POST" action="/<%= company.slug %>/newsletters/<%= newsletter.slug %>/editions/<%= edition.number %>/items/external" style="display:flex;flex-direction:column;gap:8px;max-width:520px;">
          <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
          <label style="display:flex;flex-direction:column;gap:4px;">
            <span class="fineprint">Article URL</span>
            <input type="url" name="url" class="input" placeholder="https://…" required>
          </label>
          <button type="submit" class="btn btn-sm">Add external article</button>
        </form>
      </div>
    </section>
  <% } %>

  <hr>

  <% if (!edition.items || !edition.items.length) { %>
    <p>No items yet. We’ll add post & external article blocks in the next step.</p>
  <% } else { %>
    <% edition.items
      .slice()            // copy
      .sort((a, b) => (a.position || 0) - (b.position || 0))
      .forEach(item => { %>

        <% if (item.kind === 'NOTE') { %>
          <section style="margin-bottom:20px;">
            <% if (item.title) { %>
              <h3><%= item.title %></h3>
            <% } %>
            <div class="post-content"><%- item.bodyHtml || '' %></div>
          </section>
        <% } else if (item.kind === 'POST') { %>
          <section style="margin-bottom:20px;">
            <h3><%= item.title || 'Post highlight' %></h3>
            <% if (item.highlight) { %>
              <p class="sub"><%= item.highlight %></p>
            <% } %>
            <% if (item.postId) { %>
              <p>
                <a href="/<%= company.slug %>/posts/<%= item.postId %>">View original post</a>
              </p>
            <% } %>
          </section>
        <% } else if (item.kind === 'EXTERNAL') { %>
          <section style="margin-bottom:20px;">
            <h3><%= item.title || 'External article' %></h3>
            <% if (item.source) { %>
              <p class="fineprint"><%= item.source %></p>
            <% } %>
            <div class="post-content"><%- item.summaryHtml || '' %></div>
            <% if (item.url) { %>
              <p><a href="<%= item.url %>" target="_blank" rel="noopener noreferrer">Read full article</a></p>
            <% } %>
          </section>
        <% } %>

    <% }); %>
  <% } %>
</div>
