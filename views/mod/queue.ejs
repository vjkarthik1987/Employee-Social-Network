<% layout('layouts/_layout') %>

<section>
  <h2 style="margin:0 0 12px;">Moderation Queue</h2>

  <% const items = (typeof posts !== 'undefined' && posts) ? posts : []; %>

  <% if (items.length === 0) { %>
    <div class="empty">No items pending.</div>
  <% } else { %>

    <% items.forEach(function(p){ 
      const ts = new Date(p.createdAt || p.publishedAt || p.updatedAt || Date.now());
      const attachments = Array.isArray(p.attachments) ? p.attachments : [];
      const heroUrl = (p.type === 'ANNOUNCEMENT' && p.coverImageUrl) ? String(p.coverImageUrl) : null;
    %>
      <div class="card" style="margin-bottom:1rem; padding:12px 14px;">

        <!-- HEADER -->
        <header style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px;">
          <div>
            <div style="font-weight:600;">
              <%= p.authorId?.fullName || 'User' %>
              <% if (p.type === 'ANNOUNCEMENT') { %>
                <span class="badge" style="margin-left:6px;">üì¢ Announcement</span>
                <% if (p.isPinned) { %><span class="badge" style="margin-left:4px;">üìå Pinned</span><% } %>
              <% } else if (p.type === 'POLL') { %>
                <span class="badge" style="margin-left:6px;">üìä Poll</span>
              <% } else if (p.type === 'IMAGE') { %>
                <span class="badge" style="margin-left:6px;">üñºÔ∏è Image</span>
              <% } else if (p.type === 'LINK') { %>
                <span class="badge" style="margin-left:6px;">üîó Link</span>
              <% } %>
            </div>
            <div class="fineprint" style="font-size:12px;color:#666;">
              <time datetime="<%= ts.toISOString() %>"><%= ts.toLocaleString() %></time>
              ¬∑ Company-wide
            </div>
          </div>

          <div>
            <span class="badge"><%= p.type %></span>
          </div>
        </header>

        <!-- BODY -->
        <div class="card-body" style="margin-bottom:8px;">

          <% /* Announcement heading & expiry */ %>
          <% if (p.type === 'ANNOUNCEMENT' && p.title) { %>
            <h3 style="margin:0 0 4px;font-size:1.05rem;font-weight:600;"><%= p.title %></h3>
          <% } %>
          <% if (p.type === 'ANNOUNCEMENT' && p.expiresAt) { %>
            <div class="fineprint" style="font-size:12px;color:#a55;margin-bottom:4px;">
              Visible until <%= new Date(p.expiresAt).toLocaleString() %>
            </div>
          <% } %>

          <% /* Poll quick preview */ %>
          <% if (p.type === 'POLL' && p.poll && Array.isArray(p.poll.questions) && p.poll.questions.length) {
               const q = p.poll.questions[0];
          %>
            <div style="margin-bottom:8px;padding:8px 10px;border-radius:6px;background:#f5f5f7;">
              <div style="font-weight:600;margin-bottom:4px;">
                Poll: <%= q.text || 'Untitled question' %>
              </div>
              <ul style="margin:0 0 4px 16px;padding:0;">
                <% (q.options || []).slice(0,4).forEach(function(o){ %>
                  <li style="font-size:13px;"><%= o.label %></li>
                <% }) %>
                <% if ((q.options || []).length > 4) { %>
                  <li style="font-size:12px;color:#777;">‚Ä¶and more options</li>
                <% } %>
              </ul>
              <% if (p.poll.closesAt) { %>
                <div class="fineprint" style="font-size:12px;color:#666;">
                  Closes at: <%= new Date(p.poll.closesAt).toLocaleString() %>
                </div>
              <% } %>
            </div>
          <% } %>

          <% /* Main rich text */ %>
          <% if (p.richText) { %>
            <div class="post-content" style="margin-bottom:8px;">
              <%- p.richText %>
            </div>
          <% } %>

          <% /* Announcement hero image */ %>
          <% if (heroUrl) { %>
            <div style="margin:0 0 8px;">
              <img
                src="<%= heroUrl %>"
                alt="<%= p.imageAlt || 'Announcement image' %>"
                style="max-width:100%;height:auto;border-radius:8px;display:block;"
              >
            </div>
          <% } %>

          <% /* Image grid for attachments (excluding hero if duplicated) */ %>
          <% 
            const imgs = attachments.filter(function(att){
              if (!att || !att.storageUrl) return false;
              if (heroUrl && String(att.storageUrl) === heroUrl) return false;
              return true;
            });
          %>

          <% if (imgs.length > 0) { %>
            <div class="media-grid" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;">
              <% imgs.forEach(function(att){
                  const u = String(att.storageUrl);
                  const isC = u.includes('/upload/');
                  const thumb = isC
                    ? u.replace('/upload/', '/upload/w_240,h_240,c_fill,q_auto,f_auto/')
                    : u;
              %>
                <div style="width:96px;height:96px;overflow:hidden;border-radius:6px;background:#eee;flex:0 0 auto;">
                  <img
                    src="<%= thumb %>"
                    alt="Attachment"
                    style="width:100%;height:100%;object-fit:cover;display:block;"
                  >
                </div>
              <% }) %>
            </div>
          <% } %>

          <% /* LINK preview */ %>
          <% if (p.type === 'LINK' && p.linkPreview && p.linkPreview.url) { 
               const url = String(p.linkPreview.url || '');
               let host;
               try { host = new URL(url).hostname.replace(/^www\./,''); } catch(e) { host = url; }
          %>
            <a href="<%= url %>" target="_blank" rel="noopener noreferrer"
               style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:1px solid #e0e0e0;text-decoration:none;margin-top:4px;">
              <% if (p.linkPreview.imageUrl) { 
                   const imgUrl = String(p.linkPreview.imageUrl);
                   const isCloud = imgUrl.includes('/upload/');
                   const thumb = isCloud
                     ? imgUrl.replace('/upload/','/upload/w_80,h_80,c_fill,q_auto,f_auto/')
                     : imgUrl;
              %>
                <div style="width:56px;height:56px;border-radius:6px;overflow:hidden;flex:0 0 auto;background:#eee;">
                  <img src="<%= thumb %>" alt="" style="width:100%;height:100%;object-fit:cover;">
                </div>
              <% } %>
              <div style="flex:1 1 auto;">
                <div style="font-size:13px;color:#555;">
                  <span style="margin-right:4px;">üåê</span><%= host %>
                </div>
                <div style="font-weight:600;font-size:14px;">
                  <%= p.linkPreview.title || 'Linked page' %>
                </div>
                <% if (p.linkPreview.description) { %>
                  <div style="font-size:12px;color:#666;margin-top:2px;">
                    <%= p.linkPreview.description %>
                  </div>
                <% } %>
              </div>
            </a>
          <% } %>

        </div>

        <!-- FOOTER: ACTIONS -->
        <div class="card-footer" style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:6px;">
          <form method="POST" action="/<%= company.slug %>/posts/mod/reject">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            <input type="hidden" name="postId" value="<%= p._id %>">
            <button class="btn" type="submit">Reject</button>
          </form>
          <form method="POST" action="/<%= company.slug %>/posts/mod/approve">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            <input type="hidden" name="postId" value="<%= p._id %>">
            <button class="btn btn-primary" type="submit">Approve &amp; Publish</button>
          </form>
        </div>
      </div>
    <% }) %>
  <% } %>
</section>
