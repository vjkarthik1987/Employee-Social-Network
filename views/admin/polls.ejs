<% layout('layouts/_layout') %>

<section>
  <h2>Poll Analytics</h2>
  <p class="muted">Last 200 polls · Company: <strong><%= company?.name %></strong></p>

  <table class="table" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th style="text-align:left;">Title</th>
        <th>Questions</th>
        <th>Participants</th>
        <th>Status</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody>
      <% (polls || []).forEach(function(p){ 
           const qCount = (p.poll?.questions||[]).length;
           const part = Number(p.poll?.totalParticipants || 0);
           const isClosed = !!p.poll?.isClosed;
      %>
        <tr>
          <td style="text-align:left;"><%= p.poll?.title || '(Untitled poll)' %></td>
          <td style="text-align:center;"><%= qCount %></td>
          <td style="text-align:center;"><%= part %></td>
          <td style="text-align:center;"><%= isClosed ? 'Closed' : 'Open' %></td>
          <td style="text-align:center;"><%= new Date(p.createdAt).toLocaleString() %></td>
        </tr>
        <% (p.poll?.questions || []).forEach(function(q, qi){
             const total = (q.options||[]).reduce((n,o)=>n+(o.votesCount||0),0) || 0; %>
          <tr>
            <td colspan="5" style="padding:8px 12px;background:#fafafa;">
              <div><strong>Q<%= qi+1 %>:</strong> <%= q.text %> <span class="muted">• Total votes: <%= total %></span></div>
              <div style="margin-top:6px;">
                <% (q.options||[]).forEach(function(o){
                     const votes = Number(o.votesCount||0);
                     const pct = total ? Math.round((votes/total)*100) : 0; %>
                  <div style="display:flex;gap:8px;align-items:center;margin:4px 0;">
                    <div style="min-width:220px;"><%= o.label %></div>
                    <div class="bar" style="flex:1;height:8px;background:#eee;border-radius:6px;overflow:hidden;">
                      <div style="height:8px;width:<%= pct %>%"></div>
                    </div>
                    <div style="min-width:90px;text-align:right;"><%= votes %> (<%= pct %>%)</div>
                  </div>
                <% }) %>
              </div>
            </td>
          </tr>
        <% }); %>
      <% }) %>
    </tbody>
  </table>

  <div style="margin-top:12px;display:flex;gap:12px;">
    <a class="btn" href="/<%= company.slug %>/admin/exports/polls.csv">Download CSV</a>
    <a class="btn" href="/<%= company.slug %>/admin/exports/polls.json">Download JSON</a>
  </div>
</section>
