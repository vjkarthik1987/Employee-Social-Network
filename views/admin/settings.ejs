<% layout('layouts/_layout') %>

<section class="admin-page">
  <div class="admin-page-head">
    <h2 class="admin-title">Admin Settings</h2>
    <div class="admin-subtitle">Configure branding, posting policies, retention, and points.</div>
  </div>

  <!-- Admin Quick Nav -->
  <div class="admin-pills">
    <a href="/<%= company.slug %>/admin/internal-links"
       class="pill-link <%= (typeof currentPath !== 'undefined' && currentPath.includes('/admin/internal-links')) ? 'active' : '' %>">
      üîó Internal Links
    </a>
    <a href="/<%= company.slug %>/admin/perf"
       class="pill-link <%= (typeof currentPath !== 'undefined' && currentPath.includes('/admin/perf')) ? 'active' : '' %>">
      ‚ö° Performance Logs
    </a>
    <a href="/<%= company.slug %>/admin/audit"
       class="pill-link <%= (typeof currentPath !== 'undefined' && currentPath.includes('/admin/audit')) ? 'active' : '' %>">
      üìú Audit Trail
    </a>
    <a href="/<%= company.slug %>/admin/retention"
       class="pill-link <%= (typeof currentPath !== 'undefined' && currentPath.includes('/admin/retention')) ? 'active' : '' %>">
      üóÇÔ∏è Retention Rules
    </a>
    <a href="/<%= company.slug %>/admin/assistant-docs"
       class="pill-link <%= (typeof currentPath !== 'undefined' && currentPath.includes('/admin/assistant-docs')) ? 'active' : '' %>">
      ü§ñ Assistant Docs
    </a>
    <a href="/<%= company.slug %>/admin/points"
       class="pill-link <%= (typeof currentPath !== 'undefined' && currentPath.includes('/admin/points')) ? 'active' : '' %>">
      ‚≠ê Points
    </a>
    <a href="/<%= company.slug %>/admin/settings"
       class="pill-link <%= (typeof currentPath !== 'undefined' && currentPath.includes('/admin/settings')) ? 'active' : '' %>">
      ‚öôÔ∏è Settings
    </a>
  </div>

  <!-- ONE MAIN FORM FOR ALL SETTINGS -->
  <form action="/<%= company.slug %>/admin/settings" method="POST" class="admin-form">
    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

    <!-- ===== Branding ===== -->
    <div class="card admin-card">
      <div class="admin-card-head">
        <h3>Branding</h3>
        <p>How the product appears inside your company.</p>
      </div>

      <div class="admin-grid">
        <label class="admin-field">
          <div class="admin-label">Product Name (internal brand)</div>
          <input
            name="productName"
            type="text"
            class="form-input"
            value="<%= company.productName || '' %>"
            placeholder="e.g., SunVerse / Pulse / Loop"
          >
        </label>

        <label class="admin-field">
          <div class="admin-label">Tagline (optional)</div>
          <input
            name="tagline"
            type="text"
            class="form-input"
            value="<%= company.tagline || '' %>"
            placeholder="Where our people connect & celebrate"
          >
        </label>

        <label class="admin-field">
          <div class="admin-label">Logo URL (square works best)</div>
          <input
            name="logoUrl"
            type="url"
            class="form-input"
            value="<%= company.branding?.logoUrl || '' %>"
            placeholder="https://‚Ä¶"
          >
        </label>
      </div>

      <% if (company.branding?.logoUrl) { %>
        <div class="admin-logo-preview">
          <span class="admin-muted">Preview:</span>
          <img
            src="<%= company.branding.logoUrl %>"
            alt="Logo preview"
            class="admin-logo-img"
          >
        </div>
      <% } %>
    </div>

    <!-- ===== Theme Colors ===== -->
    <div class="card admin-card">
      <div class="admin-card-head">
        <h3>Theme Colors</h3>
        <p>Used across headers, buttons, and highlights.</p>
      </div>

      <div class="admin-row admin-row-tight">
        <label class="admin-field">
          <div class="admin-label">Primary Color</div>
          <input
            name="themePrimary"
            type="color"
            value="<%= company.branding?.theme?.primary || '#1976d2' %>"
            class="form-input-color"
          >
        </label>

        <label class="admin-field">
          <div class="admin-label">Secondary / Accent Color</div>
          <input
            name="themeSecondary"
            type="color"
            value="<%= company.branding?.theme?.secondary || company.branding?.theme?.primary || '#1976d2' %>"
            class="form-input-color"
          >
        </label>

        <div class="admin-swatch">
          <div class="admin-muted">Preview:</div>
          <div class="admin-swatch-box"
               title="Primary"
               style="background:<%= company.branding?.theme?.primary || '#0a66c2' %>;"></div>
          <div class="admin-swatch-box"
               title="Secondary"
               style="background:<%= company.branding?.theme?.secondary || company.branding?.theme?.primary || '#0a66c2' %>;"></div>
        </div>
      </div>
    </div>

    <!-- ===== Posting & Notifications ===== -->
    <div class="card admin-card">
      <div class="admin-card-head">
        <h3>Posting & Notifications</h3>
        <p>Control who can post, and whether email notifications are enabled.</p>
      </div>

      <div class="admin-stack">
        <div class="admin-block">
          <div class="admin-label">Posting mode</div>

          <label class="admin-radio">
            <input
              type="radio"
              name="postingMode"
              value="OPEN"
              <%= (company.policies?.postingMode || 'OPEN') === 'OPEN' ? 'checked' : '' %>
            >
            <span>Open ‚Äî anyone in the org can post</span>
          </label>

          <label class="admin-radio">
            <input
              type="radio"
              name="postingMode"
              value="MODERATED"
              <%= (company.policies?.postingMode || 'OPEN') === 'MODERATED' ? 'checked' : '' %>
            >
            <span>Moderated ‚Äî only admins + approved roles can post</span>
          </label>
        </div>

        <label class="admin-check">
          <input
            type="checkbox"
            name="notificationsEnabled"
            value="1"
            <%= company.policies?.notificationsEnabled ? 'checked' : '' %>
          >
          <span>Email notifications for important updates</span>
        </label>
      </div>
    </div>

    <!-- ===== Content Policy ===== -->
    <div class="card admin-card">
      <div class="admin-card-head">
        <h3>Content Policy</h3>
        <p>Blocked words will be flagged in posts and comments. Separate them with commas.</p>
      </div>

      <label class="admin-field">
        <div class="admin-label">Blocked Words (comma-separated)</div>
        <textarea
          name="blockedWordsCSV"
          rows="3"
          class="admin-textarea"
        ><%= (company.policies?.blockedWords || []).join(', ') %></textarea>
      </label>
    </div>

    <!-- ===== Data Retention ===== -->
    <div class="card admin-card">
      <div class="admin-card-head">
        <h3>Data Retention</h3>
        <p>Soft-deleted items older than this many days can be permanently removed by the retention job.</p>
      </div>

      <label class="admin-inline">
        <span class="admin-label">Retention period (days)</span>
        <input
          type="number"
          name="retentionDays"
          min="1"
          max="3650"
          value="<%= company.policies?.retentionDays || 365 %>"
          class="admin-number"
        >
      </label>
    </div>

    <hr class="admin-divider" />

    <!-- ===== Points & Gamification ===== -->
    <div class="card admin-card">
      <div class="admin-card-head">
        <h3>Points & Gamification</h3>
        <p>Assign points to actions like posting, comments, replies, and reactions.</p>
      </div>

      <label class="admin-check">
        <input type="checkbox" name="gamificationEnabled" value="1"
          <%= company.gamification?.enabled ? 'checked' : '' %> />
        <span>Enable points</span>
      </label>

      <div class="admin-grid admin-grid-2">
        <label class="admin-field">
          <div class="admin-label">Points: Post created</div>
          <input class="input" type="number" name="pointsPostCreated"
            value="<%= company.gamification?.rules?.POST_CREATED ?? 0 %>">
        </label>

        <label class="admin-field">
          <div class="admin-label">Points: Comment created</div>
          <input class="input" type="number" name="pointsCommentCreated"
            value="<%= company.gamification?.rules?.COMMENT_CREATED ?? 0 %>">
        </label>

        <label class="admin-field">
          <div class="admin-label">Points: Reply created</div>
          <input class="input" type="number" name="pointsReplyCreated"
            value="<%= company.gamification?.rules?.REPLY_CREATED ?? 0 %>">
        </label>

        <label class="admin-field">
          <div class="admin-label">Points: Reaction added</div>
          <input class="input" type="number" name="pointsReactionAdded"
            value="<%= company.gamification?.rules?.REACTION_ADDED ?? 0 %>">
        </label>
      </div>
    </div>

    <!-- ===== Plan & Usage (Read-only) ===== -->
    <div class="card admin-card">
      <div class="admin-card-head">
        <h3>Plan & Usage</h3>
        <p>Read-only subscription status and license usage.</p>
      </div>

      <div class="admin-kv">
        <div class="admin-kv-row">
          <span class="admin-muted">Plan</span>
          <strong><%= company.planState || 'FREE_TRIAL' %></strong>
        </div>

        <% if (company.trialEndsAt) { %>
          <div class="admin-kv-row">
            <span class="admin-muted">Trial ends</span>
            <strong><%= new Date(company.trialEndsAt).toDateString() %></strong>
          </div>
        <% } %>

        <div class="admin-kv-row">
          <span class="admin-muted">Seats</span>
          <strong><%= company.license?.used || 0 %></strong>
          <span class="admin-muted">/</span>
          <strong><%= company.license?.seats || 25 %></strong>
        </div>

        <% if (company.license?.validTill) { %>
          <div class="admin-kv-row">
            <span class="admin-muted">Valid till</span>
            <strong><%= new Date(company.license.validTill).toDateString() %></strong>
          </div>
        <% } %>
      </div>

      <div class="admin-actions admin-actions-left">
        <button
          class="btn"
          type="submit"
          formaction="/<%= company.slug %>/admin/support/upgrade"
          formmethod="POST"
        >
          Request upgrade
        </button>
      </div>
    </div>

    <!-- ===== Main Save Button ===== -->
    <div class="admin-actions">
      <button class="btn btn-primary" type="submit">Save Settings</button>
    </div>
  </form>

  <!-- ===== Utilities ===== -->
  <div class="card admin-card admin-utilities">
    <div class="admin-utilities-title">Utilities</div>

    <div class="util-actions">
      <form method="GET" action="/<%= company.slug %>/admin/export/backup.json">
        <button class="btn" type="submit">‚¨áÔ∏è Download JSON Backup</button>
      </form>

      <form method="GET" action="/<%= company.slug %>/admin/export/backup.ndjson">
        <button class="btn" type="submit">‚¨áÔ∏è Download NDJSON Backup</button>
      </form>

      <form
        method="POST"
        action="/<%= company.slug %>/admin/retention/run"
        onsubmit="return confirm('Run retention now? This will hard-delete expired soft-deleted items.');"
      >
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <button class="btn danger" type="submit">üóëÔ∏è Run Retention</button>
      </form>
    </div>
  </div>
</section>
