<% layout('layouts/_layout') %>

<section style="max-width:960px;margin:0 auto;">
  <h2 style="margin:0 0 12px;">Performance Dashboard</h2>
  <p class="muted" style="margin-top:-6px;">Lightweight timings from server-side feed & post endpoints (in-memory). Refresh to update.</p>

  <h3 style="margin:18px 0 8px;">Route Summary</h3>
  <div class="card">
    <table class="table" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Route</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">Samples</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">Avg (ms)</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">p95 (ms)</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">Last (ms)</th>
        </tr>
      </thead>
      <tbody>
        <% if (!rows || !rows.length) { %>
          <tr><td colspan="5" style="padding:10px;">No timings yet. Visit the feed and come back.</td></tr>
        <% } else { %>
          <% rows.forEach(r => { %>
            <tr>
              <td style="padding:8px;border-bottom:1px solid #f5f5f5;"><code><%= r.route %></code></td>
              <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= r.count %></td>
              <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= r.avg %></td>
              <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= r.p95 %></td>
              <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= r.last %></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <h3 style="margin:18px 0 8px;">Cache</h3>
    <div class="card" style="padding:12px;">
    <% if (!cache) { %>
        <div>No cache stats yet.</div>
    <% } else { %>
        <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
        <div>Hit: <strong><%= cache.agg.hit %></strong></div>
        <div>Miss: <strong><%= cache.agg.miss %></strong></div>
        <div>Busts: <strong><%= cache.agg.bust %></strong></div>
        <div>Hit Rate: <strong><%= cache.hitRate %>%</strong></div>
        </div>
        <details style="margin-top:8px;">
        <summary>Recent cache events</summary>
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:6px;">
            <thead><tr><th align="left">Time</th><th align="left">Type</th><th align="left">Key</th><th align="right">Count</th></tr></thead>
            <tbody>
            <% (cache.recent||[]).slice(0,50).forEach(ev => { %>
                <tr>
                <td style="padding:6px;border-bottom:1px solid #f2f2f2;"><%= new Date(ev.ts).toLocaleString() %></td>
                <td style="padding:6px;border-bottom:1px solid #f2f2f2;"><%= ev.type %></td>
                <td style="padding:6px;border-bottom:1px solid #f2f2f2;"><code><%= ev.key %></code></td>
                <td style="padding:6px;border-bottom:1px solid #f2f2f2;" align="right"><%= ev.count %></td>
                </tr>
            <% }) %>
            </tbody>
        </table>
        </details>
    <% } %>
    </div>


  <h3 style="margin:18px 0 8px;">Recent Events</h3>
  <div class="card" style="overflow:auto;max-height:360px;">
    <table class="table" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Time</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Route</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">Duration (ms)</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">Count</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">Page</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid #eee;">Limit</th>
        </tr>
      </thead>
      <tbody>
        <% (recent || []).forEach(ev => { %>
          <tr>
            <td style="padding:8px;border-bottom:1px solid #f5f5f5;"><%= new Date(ev.ts).toLocaleString() %></td>
            <td style="padding:8px;border-bottom:1px solid #f5f5f5;"><code><%= ev.route %></code></td>
            <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= Math.round(ev.durationMs) %></td>
            <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= ev.count %></td>
            <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= ev.page ?? '' %></td>
            <td style="padding:8px;border-bottom:1px solid #f5f5f5;text-align:right;"><%= ev.limit ?? '' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>
