<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="<%= csrfToken || '' %>">
  <title><%= typeof title !== 'undefined' ? title : 'Engage' %></title>
  <link rel="stylesheet" href="/css/styles.css?v=<%= Date.now() %>">
  <% 
    // --- Theme variables ---
    const _p = company?.branding?.theme?.primary || '#0a66c2';
    const _a = company?.branding?.theme?.accent  || _p;

    // Prefer explicit user preference, else fall back to company default
    const _userPref = (typeof currentUser !== 'undefined' && currentUser?.preferences?.darkMode)
                   ?? (typeof user !== 'undefined' && user?.preferences?.darkMode)
                   ?? null; // null means follow company default
    const _companyDefaultDark = !!(company?.branding?.theme?.darkModeDefault);
    const _prefersDark = (_userPref === true) || (_userPref === null && _companyDefaultDark);
  %>

  <% if (company?.branding?.logoUrl) { %>
    <link rel="icon" href="<%= company.branding.logoUrl %>" type="image/png">
  <% } %>

  <style>
    :root {
      --primary: <%= _p %>;
      --accent:  <%= _a %>;
      --bg:      <%= _prefersDark ? '#121212' : '#f6f7f9' %>;
      --text:    <%= _prefersDark ? '#eaeaea' : '#111' %>;
      --navH:    56px;
    }
    html, body { background: var(--bg); color: var(--text); }
  </style>
</head>

<body style="margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">

  <!-- Global Navbar -->
  <%- include('../partials/navbar', {
    org:           (typeof org !== 'undefined' ? org : null),
    currentUser:   (typeof currentUser !== 'undefined' ? currentUser : null),
    company:       (typeof company !== 'undefined' ? company : null),
    user:          (typeof user !== 'undefined' ? user : null),
    companySlug:   (typeof companySlug !== 'undefined' ? companySlug : null)
  }) %>

  <!-- Main Page Container -->
  <div class="page-container" style="
    display:flex; flex-direction:column; min-height:100vh; padding:20px; box-sizing:border-box;">
    <main class="app-shell">
      <div class="col-center">
        <%- include('../partials/flash') %>
        <%- body %>
      </div>
    </main>
  </div>

  <!-- Right side bar -->
  <div class="rightBar">
    <%- include('../partials/_sidebar_links', { company, internalLinks: (typeof internalLinks !== 'undefined' ? internalLinks : []) }) %>
    <!-- put widgets/links/lists here -->
  </div>
</body>
</html>
