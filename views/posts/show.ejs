<% layout('layouts/_layout') %>
<style>
  /* Light blue page background for post detail */
.page.page--post-show {
  background: #e7f0ff;      /* tweak shade as you like */
  min-height: 100vh;
}

/* Centered content column */
.post-page-wrap {
  max-width: 900px;
  margin: 24px auto 32px;
  padding: 0 12px;
}

/* Make the outer "card" transparent ‚Äì just a layout shell */
.post-page-shell {
  margin-bottom: 1rem;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}

</style>

<main class="page page--post-show">
  <section class="post-page-wrap">
    <!-- Post card -->
    <div class="card post-page-shell">
    <div class="card-header" style="display:flex;justify-content:space-between;">
      <div>
        <strong><%= post.authorId?.fullName || 'User' %></strong>
        <small>
          ‚Ä¢ <%= new Date(post.createdAt || post.publishedAt).toLocaleString() %>
          <% if (post.type) { %> ‚Ä¢ <span class="badge"><%= post.type %></span><% } %>
          <% if (post.group && post.group._id) { %>
            ‚Ä¢ in <a href="/<%= company.slug %>/g/<%= post.group._id %>"><%= post.group.name %></a>
          <% } %>
        </small>
      </div>

      

      <% if (user && (String(user._id) === String(post.authorId?._id || post.authorId) || ['ORG_ADMIN','MODERATOR'].includes(user.role))) { %>
        <form method="POST" action="/<%= company.slug %>/posts/<%= post._id %>/delete" onsubmit="return confirm('Delete this post?')">
          <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
          <button class="btn btn-ghost" type="submit">Delete</button>
        </form>
      <% } %>
    </div>

    <div class="post-metrics" style="margin:.5rem 0; color:#666; display:flex; gap:1rem; flex-wrap:wrap; font-size:.95rem; margin-bottom: 20px;">
      <span>üëÅ <%= post.viewsCount || 0 %> views</span>
      <span>üéâ <%= post.totalReactions || 0 %> reactions</span>
      <span>üí¨ <%= post.commentsCount || 0 %> comments</span>
      <span>‚ÜóÔ∏è <%= post.engagementRate || 0 %>% engagement</span>
      <% if (typeof viewed !== 'undefined' && viewed) { %>
        <span style="opacity:.6;">üëÅ Viewed</span>
      <% } %>
    </div>

    <!-- Reactions (single source of truth for counts + buttons) -->
    <%- include('../partials/_post_card', { company, user, post, compact: false }) %>
  </div>

  <!-- Comments -->
  <section class="comments-area" style="margin-top:18px;">
    <h3 class="ca-title">Comments</h3>
  
    <% if (user) { %>
      <!-- Top-level composer -->
      <form method="POST"
            action="/<%= company.slug %>/api/posts/<%= post._id %>/comments"
            class="cc-composer"
            id="new-comment-form">
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <div class="cc-row">
          <img class="cc-avatar" src="<%= user?.avatarUrl || '/img/avatar.png' %>" alt="">
          <div class="cc-inputwrap">
            <textarea name="content" class="cc-input" rows="1" placeholder="Write a comment‚Ä¶" maxlength="3000" required enterkeyhint="send"></textarea>

            <div class="cc-tools">
              <button type="button" class="cc-emoji-btn" title="Add emoji" aria-label="Add emoji">üôÇ</button>
              <span class="cc-count" data-cc-count>0/3000</span>
              <button class="cc-send" type="submit" disabled aria-label="Post comment">‚û§</button>
            </div>
          </div>
        </div>
      </form>
    <% } %>
  
    <ul id="comments-list" class="cc-list">
      <% (comments || []).forEach(function(c){ %>
        <% const r = (repliesByParent && repliesByParent[String(c._id)]) ? repliesByParent[String(c._id)] : []; %>
        <%- include('../partials/_comment', { company, user, post, comment: c, replies: r, repliesByParent }) %>
      <% }) %>      
    </ul>    
  </section>
  
</section>
</main>

<!-- Reactions JS (PUT /:org/api/reactions) -->
<script>
(function(){
  const ORG = "<%= company.slug %>";

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-react]');
    if (!btn) return;

    const bar = btn.closest('[data-react-scope]');
    if (!bar) return;

    const type = btn.getAttribute('data-react');              // e.g. LIKE
    const targetType = bar.getAttribute('data-target-type');  // 'post'
    const targetId = bar.getAttribute('data-target-id');

    const resp = await fetch(`/${ORG}/api/reactions`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ targetType, targetId, reactionType: type })
    });
    const data = await resp.json();
    if (!data.ok) { alert('Could not react.'); return; }

    const spans = {
      LIKE:       bar.querySelector('[data-rc="LIKE"]'),
      HEART:      bar.querySelector('[data-rc="HEART"]'),
      CELEBRATE:  bar.querySelector('[data-rc="CELEBRATE"]'),
      SUPPORT:    bar.querySelector('[data-rc="SUPPORT"]'),
      LAUGH:      bar.querySelector('[data-rc="LAUGH"]'),
      INSIGHTFUL: bar.querySelector('[data-rc="INSIGHTFUL"]'),
      THANKS:     bar.querySelector('[data-rc="THANKS"]')
    };
    const bump = (el, d) => { if (!el) return; el.textContent = Math.max(0, (parseInt(el.textContent||'0',10) + d)); };

    if (data.added) {
      bump(spans[data.added], +1);
      bar.querySelectorAll('[data-react].active')?.forEach(b => b.classList.remove('active'));
      const newBtn = bar.querySelector(`[data-react="${data.added}"]`);
      if (newBtn) newBtn.classList.add('active');
    }

    if (data.removed) {
      bump(spans[data.removed], -1);
      bar.querySelectorAll('[data-react].active')?.forEach(b => b.classList.remove('active'));
    }

    if (data.changedTo) {
      if (data.prevType && data.prevType !== data.changedTo) {
        bump(spans[data.prevType], -1);
      }
      bump(spans[data.changedTo], +1);
      bar.querySelectorAll('[data-react].active')?.forEach(b => b.classList.remove('active'));
      const newBtn = bar.querySelector(`[data-react="${data.changedTo}"]`);
      if (newBtn) newBtn.classList.add('active');
    }

    const totalEl = bar.querySelector('[data-total-reactions]');
    if (totalEl) {
      const sum = Array.from(bar.querySelectorAll('.rc')).reduce((n, s) => n + parseInt(s.textContent||'0',10), 0);
      totalEl.textContent = String(sum);
    }
  });
})();
</script>

<!-- Comments JS (top-level + replies + delete via AJAX + composer behavior) -->
<!-- <script>
(function(){
  const org = "<%= company.slug %>";
  const root = document.querySelector('.comments-area');
  if (!root) return;

  const commentsCountEl = document.getElementById('comments-count');
  const list = document.getElementById('comments-list');

  function bumpCommentsCount(delta){
    if (!commentsCountEl) return;
    const n = parseInt(commentsCountEl.textContent || '0', 10) + (delta || 0);
    commentsCountEl.textContent = Math.max(0, n);
  }

  // --- Composer enhancer (top-level + replies) ---
  function bindComposer(form){
    if (!form || form.dataset.ccBound === '1') return;  // bind once
    form.dataset.ccBound = '1';

    const ta = form.querySelector('.cc-input');
    const cnt = form.querySelector('[data-cc-count]');
    const send = form.querySelector('.cc-send');
    const emojiBtn = form.querySelector('.cc-emoji-btn');
    const max = ta ? parseInt(ta.getAttribute('maxlength') || '3000', 10) : 3000;
    const row = form.querySelector('.cc-row');

    if (!ta) return;

    const autosize = () => {
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 160) + 'px';
      if (row) row.classList.toggle('is-multiline', ta.scrollHeight > 48);
    };

    const refresh = () => {
      const len = ta.value.length;
      if (cnt) cnt.textContent = `${len}/${max}`;
      if (send) send.disabled = ta.value.trim().length === 0;
    };

    // Enter ‚Üí submit, Shift+Enter ‚Üí newline
    ta.addEventListener('keydown', (e) => {
      if (e.isComposing) return;
      if (e.key === 'Enter' && e.shiftKey) return; // new line
      if (e.key === 'Enter') {
        e.preventDefault();
        if (send && !send.disabled) form.requestSubmit();
      }
    });

    ta.addEventListener('input', () => { autosize(); refresh(); });

    // Simple emoji insert
    if (emojiBtn) {
      emojiBtn.addEventListener('click', () => {
        const emoji = 'üôÇ';
        const start = ta.selectionStart ?? ta.value.length;
        const end   = ta.selectionEnd ?? ta.value.length;
        ta.value = ta.value.slice(0, start) + emoji + ta.value.slice(end);
        ta.focus();
        ta.selectionStart = ta.selectionEnd = start + emoji.length;
        autosize(); refresh();
      });
    }

    // Initial
    autosize(); refresh();
  }

  // --- Top-level comment submit (AJAX) ---
  const newForm = document.getElementById('new-comment-form');
  if (newForm) {
    bindComposer(newForm);

    newForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const body = new URLSearchParams(new FormData(newForm));
      try {
        const resp = await fetch(newForm.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body
        });
        const data = await resp.json();
        if (!data.ok) {
          alert(data.error || 'Could not add comment.');
          return;
        }
        const temp = document.createElement('div');
        temp.innerHTML = data.html.trim();
        const li = temp.firstElementChild;
        if (li && list) list.appendChild(li);
        bumpCommentsCount(data.commentsCountDelta || 0);
        newForm.reset();
        // reset height
        const ta = newForm.querySelector('.cc-input');
        if (ta) { ta.style.height = '40px'; }
      } catch (err) {
        console.error(err);
        alert('Network error.');
      }
    });
  }

  // --- Global click: Reply toggle + Delete ---
  document.addEventListener('click', async (e) => {
    const replyToggle = e.target.closest('[data-reply-toggle]');
    if (replyToggle) {
      e.preventDefault();
      const id = replyToggle.getAttribute('data-reply-toggle');
      const form = document.getElementById('reply-form-' + id);
      if (form) {
        const willShow = (form.style.display === 'none' || !form.style.display);
        form.style.display = willShow ? 'block' : 'none';
        if (willShow) {
          bindComposer(form);
          const ta = form.querySelector('.cc-input');
          if (ta) {
            ta.focus();
            ta.setSelectionRange(ta.value.length, ta.value.length);
          }
        }
      }
      return;
    }

    // Delete (supports both data-delete-comment and data-ajax-delete)
    const delBtn = e.target.closest('[data-delete-comment],[data-ajax-delete]');
    if (delBtn) {
      e.preventDefault();
      const commentId = delBtn.getAttribute('data-delete-comment') || delBtn.getAttribute('data-comment-id');
      if (!commentId) return;
      if (!confirm('Delete this comment?')) return;

      try {
        const resp = await fetch(`/${org}/api/comments/${commentId}`, {
          method: 'DELETE',
          headers: { 'Accept': 'application/json' }
        });
        const data = await resp.json();
        if (!data.ok) {
          alert('Delete failed');
          return;
        }

        const selector = data.isReply ? `[data-reply-id="${data.commentId}"]`
                                      : `[data-comment-id="${data.commentId}"]`;
        const node = document.querySelector(selector);
        if (node) {
          const content = node.querySelector('.comment-content');
          if (content) content.innerHTML = '<em style="color:#888;">(deleted)</em>';
          node.querySelectorAll('[data-delete-comment],[data-ajax-delete],[data-reply-toggle]').forEach(el => el.remove());
        }
        bumpCommentsCount(data.commentsCountDelta || 0);
      } catch (err) {
        console.error(err);
        alert('Network error while deleting.');
      }
    }
  });

  // Delegate: reply form submit (has data-ajax-reply)
  document.addEventListener('submit', async (e) => {
    const f = e.target;
    if (!f.matches('[data-ajax-reply]')) return;
    e.preventDefault();

    // Encode as application/x-www-form-urlencoded
    const body = new URLSearchParams(new FormData(f));

    const resp = await fetch(f.action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': 'application/json'
      },
      body
    });

    const data = await resp.json();
    if (!data.ok) return alert('Could not add reply.');

    const parentId = data.parentCommentId;
    // find or create the replies <ul> under that comment
    let container = document.querySelector(`[data-comment-id="${parentId}"] [data-replies]`);
    if (!container) {
      const parentCard = document.querySelector(`[data-comment-id="${parentId}"]`);
      if (parentCard) {
        container = document.createElement('ul');
        container.className = 'replies';
        container.setAttribute('data-replies', '');
        parentCard.appendChild(container);
      }
    }

    if (container) {
      container.style.display = 'block';
      const temp = document.createElement('div');
      temp.innerHTML = data.html.trim();
      const li = temp.firstElementChild;
      if (li) container.appendChild(li);
    }

    bumpCommentsCount(data.commentsCountDelta || 0);
    f.reset();
    f.style.display = 'none';
  });

  // --- Bind composers for any pre-rendered reply forms (if any are visible) ---
  root.querySelectorAll('.cc-reply').forEach(bindComposer);

})();
</script> -->

<!-- Comments JS (top-level + replies + delete via AJAX + composer behavior) -->
<script>
(function(){
  const org  = "<%= company.slug %>";
  const root = document.querySelector('.comments-area');
  if (!root) return;

  const commentsCountEl = document.getElementById('comments-count');
  const list = document.getElementById('comments-list');

  function bumpCommentsCount(delta){
    if (!commentsCountEl) return;
    const n = parseInt(commentsCountEl.textContent || '0', 10) + (delta || 0);
    commentsCountEl.textContent = Math.max(0, n);
  }

  // --- Composer enhancer (top-level + replies) ---
  function bindComposer(form){
    if (!form || form.dataset.ccBound === '1') return;
    form.dataset.ccBound = '1';

    const ta       = form.querySelector('.cc-input');
    const cnt      = form.querySelector('[data-cc-count]');
    const send     = form.querySelector('.cc-send');
    const emojiBtn = form.querySelector('.cc-emoji-btn');
    const row      = form.querySelector('.cc-row');
    if (!ta) return;

    const max = parseInt(ta.getAttribute('maxlength') || '3000', 10);

    const autosize = () => {
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 160) + 'px';
      if (row) row.classList.toggle('is-multiline', ta.scrollHeight > 48);
    };

    const refresh = () => {
      const len = ta.value.length;
      if (cnt)  cnt.textContent  = `${len}/${max}`;
      if (send) send.disabled    = ta.value.trim().length === 0;
    };

    // Enter ‚Üí submit, Shift+Enter ‚Üí newline
    ta.addEventListener('keydown', (e) => {
      if (e.isComposing) return;
      if (e.key === 'Enter' && e.shiftKey) return; // newline
      if (e.key === 'Enter') {
        e.preventDefault();
        if (send && !send.disabled) form.requestSubmit();
      }
    });

    ta.addEventListener('input', () => { autosize(); refresh(); });

    // Simple emoji insert
    if (emojiBtn) {
      emojiBtn.addEventListener('click', () => {
        const emoji = 'üôÇ';
        const start = ta.selectionStart ?? ta.value.length;
        const end   = ta.selectionEnd ?? ta.value.length;
        ta.value = ta.value.slice(0, start) + emoji + ta.value.slice(end);
        ta.focus();
        ta.selectionStart = ta.selectionEnd = start + emoji.length;
        autosize(); refresh();
      });
    }

    // Initial
    autosize(); refresh();
  }

  // --- Top-level comment submit (AJAX) ---
  const newForm = document.getElementById('new-comment-form');
  if (newForm) {
    bindComposer(newForm);

    newForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const body = new URLSearchParams(new FormData(newForm));

      try {
        const resp = await fetch(newForm.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body
        });
        const data = await resp.json();
        if (!data.ok) {
          alert(data.error || 'Could not add comment.');
          return;
        }

        const temp = document.createElement('div');
        temp.innerHTML = data.html.trim();
        const li = temp.firstElementChild;
        if (li && list) {
          // show newest on top (optional; change to appendChild if you prefer bottom)
          if (list.firstElementChild) list.prepend(li);
          else list.appendChild(li);
        }

        bumpCommentsCount(data.commentsCountDelta || 0);
        newForm.reset();
        const ta = newForm.querySelector('.cc-input');
        if (ta) ta.style.height = '40px';
      } catch (err) {
        console.error(err);
        alert('Network error.');
      }
    });
  }

  // --- Global click: Reply toggle + Delete ---
  document.addEventListener('click', async (e) => {
    const replyToggle = e.target.closest('[data-reply-toggle]');
    if (replyToggle) {
      e.preventDefault();
      const id   = replyToggle.getAttribute('data-reply-toggle');
      const form = document.getElementById('reply-form-' + id);
      if (form) {
        const willShow = (form.style.display === 'none' || !form.style.display);
        form.style.display = willShow ? 'block' : 'none';
        if (willShow) {
          bindComposer(form);
          const ta = form.querySelector('.cc-input');
          if (ta) {
            ta.focus();
            ta.setSelectionRange(ta.value.length, ta.value.length);
          }
        }
      }
      return;
    }

    // Delete (supports data-delete-comment / data-ajax-delete)
    const delBtn = e.target.closest('[data-delete-comment],[data-ajax-delete]');
    if (delBtn) {
      e.preventDefault();
      const commentId = delBtn.getAttribute('data-delete-comment') || delBtn.getAttribute('data-comment-id');
      if (!commentId) return;
      if (!confirm('Delete this comment?')) return;

      try {
        const resp = await fetch(`/${org}/api/comments/${commentId}`, {
          method: 'DELETE',
          headers: { 'Accept': 'application/json' }
        });
        const data = await resp.json();
        if (!data.ok) {
          alert('Delete failed');
          return;
        }

        const selector = data.isReply
          ? `[data-reply-id="${data.commentId}"]`
          : `[data-comment-id="${data.commentId}"]`;

        const node = document.querySelector(selector);
        if (node) {
          const content = node.querySelector('.comment-content');
          if (content) content.innerHTML = '<em style="color:#888;">(deleted)</em>';
          node.querySelectorAll('[data-delete-comment],[data-ajax-delete],[data-reply-toggle]').forEach(el => el.remove());
        }

        bumpCommentsCount(data.commentsCountDelta || 0);
      } catch (err) {
        console.error(err);
        alert('Network error while deleting.');
      }
    }
  });

  // --- Reply form submit (AJAX) ---
  document.addEventListener('submit', async (e) => {
    const f = e.target;
    if (!f.matches('[data-ajax-reply]')) return;
    e.preventDefault();

    const body = new URLSearchParams(new FormData(f));

    const resp = await fetch(f.action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': 'application/json'
      },
      body
    });

    const data = await resp.json();
    if (!data.ok) {
      alert(data.error || 'Could not add reply.');
      return;
    }

    const parentId = data.parentCommentId;

    // Find or create the replies <ul> under that comment
    let container = document.querySelector(`[data-comment-id="${parentId}"] [data-replies]`);
    if (!container) {
      const parentCard = document.querySelector(`[data-comment-id="${parentId}"]`);
      if (parentCard) {
        container = document.createElement('ul');
        container.className = 'replies';
        container.setAttribute('data-replies', '');
        parentCard.appendChild(container);
      }
    }

    if (container) {
      container.style.display = 'block';
      const temp = document.createElement('div');
      temp.innerHTML = data.html.trim();
      const li = temp.firstElementChild;
      if (li) container.appendChild(li);
    }

    bumpCommentsCount(data.commentsCountDelta || 0);
    f.reset();
    f.style.display = 'none';
  });

  // Bind composers for any pre-rendered reply forms (if visible)
  root.querySelectorAll('.cc-reply').forEach(bindComposer);

})();
</script>

  