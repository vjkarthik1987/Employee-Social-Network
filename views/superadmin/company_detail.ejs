<% layout('layouts/_superadmin') %>

<div class="superadmin-shell">
  <%- include('../partials/_superadmin_sidebar', { currentSection: 'companies' }) %>

  <div class="wrap" style="margin:0;">
    <% if (message) { %>
        <div class="card" style="margin:16px 0;border-left:4px solid var(--jaango-green);">
          <p style="margin:0;color:var(--ink-700);"><%= message %></p>
        </div>
      <% } %>
    
    <!-- Page header -->
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:24px;">
      <div>
        <h1 class="h2" style="margin-bottom:4px;">
          <%= company.name %>
        </h1>
        <p class="sub" style="margin:0;">
          <code style="background:var(--paper-2);padding:2px 6px;border-radius:999px;font-size:12px;">
            <%= company.slug %>
          </code>
          · <%= company.dataRegion %> · <%= company.timezone %>
        </p>
      </div>

      <form method="POST" action="/super-admin/logout">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="btn btn-ghost">
          Log out
        </button>
      </form>
    </div>

    <!-- Top cards: plan + usage -->
    <section class="section" style="padding-top:0;">
        <div class="features" style="grid-template-columns:repeat(4, minmax(0,1fr));">
        <!-- Plan / license -->
        <div class="card">
          <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Plan & License</h3>
          <p style="margin:0 0 8px;color:var(--ink-500);">
            State: <strong><%= company.planState %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Plan kind: <%= company.plan?.kind || 'trial' %>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Plan seats: <%= company.plan?.seats || 0 %>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            License seats: <%= company.license?.seats || 0 %> · used <%= company.license?.used || 0 %>
          </p>
          <p style="margin:0;color:var(--ink-500);">
            Trial: <%= trialStatus %>
            <% if (company.trialEndsAt) { %>
              · ends <%= company.trialEndsAt.toISOString().slice(0,10) %>
            <% } %>
          </p>
        </div>

        <!-- Verification & status -->
        <div class="card">
          <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Status & Verification</h3>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Status:
            <strong style="text-transform:capitalize;"><%= company.status %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Verification: <strong><%= verificationStatus %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Created: <%= company.createdAt ? company.createdAt.toISOString().slice(0,10) : '-' %>
          </p>
          <p style="margin:0;color:var(--ink-500);">
            Updated: <%= company.updatedAt ? company.updatedAt.toISOString().slice(0,10) : '-' %>
          </p>
        </div>

        <!-- Usage summary -->
        <div class="card">
          <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Usage summary</h3>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Users: <strong><%= usersCount %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Groups: <strong><%= groupsCount %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Posts: <strong><%= postsCount %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Comments: <strong><%= commentsCount %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Attachments: <strong><%= attachmentsCount %></strong>
          </p>
          <p style="margin:0 0 4px;color:var(--ink-500);">
            Poll responses: <strong><%= pollResponsesCount %></strong>
          </p>
          <p style="margin:0;color:var(--ink-500);">
            Internal links: <strong><%= internalLinksCount %></strong>
          </p>
        </div>

                <!-- Actions -->
        <div class="card">
          <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Actions</h3>
          <p style="margin:0 0 8px;color:var(--ink-500);">
            Perform admin actions on this company.
          </p>

          <form method="POST" action="/super-admin/companies/<%= company._id %>/extend-trial" style="margin:0 0 6px;">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button type="submit" class="btn btn-ghost" style="width:100%;justify-content:center;font-size:13px;">
              Extend trial by 30 days
            </button>
          </form>

          <% if (company.status === 'active') { %>
            <form method="POST" action="/super-admin/companies/<%= company._id %>/suspend" style="margin:0 0 6px;">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-ghost" style="width:100%;justify-content:center;font-size:13px;color:#b91c1c;">
                Suspend company
              </button>
            </form>
          <% } else { %>
            <form method="POST" action="/super-admin/companies/<%= company._id %>/activate" style="margin:0 0 6px;">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-ghost" style="width:100%;justify-content:center;font-size:13px;color:var(--jaango-green);">
                Activate company
              </button>
            </form>
          <% } %>
        </div>

      </div>
    </section>

      <!-- Usage & Storage -->
  <section class="section" style="padding-top:0;margin-top:24px;">
    <h2 class="h3" style="margin:0 0 12px;">Usage & Storage</h2>
    <p class="sub" style="margin:0 0 16px;">
      High-level view of how this tenant is consuming platform resources.
    </p>

    <div class="features" style="grid-template-columns:repeat(3, minmax(0,1fr));">
      <!-- Seats / License -->
      <div class="card">
        <h3 style="margin:0 0 4px;font-size:16px;color:var(--ink-900);">
          License seats
        </h3>
        <p style="margin:0 0 8px;color:var(--ink-500);">
          Assigned vs used seats.
        </p>
        <p style="margin:0;font-size:24px;font-weight:700;">
          <%= licenseUsed %> / <%= licenseSeats %>
        </p>
        <p style="margin:8px 0 0;font-size:13px;color:var(--ink-500);">
          Utilisation:
          <strong><%= licenseUtilisation %>%</strong>
        </p>
      </div>

      <!-- Storage -->
      <div class="card">
        <h3 style="margin:0 0 4px;font-size:16px;color:var(--ink-900);">
          Attachment storage
        </h3>
        <p style="margin:0 0 8px;color:var(--ink-500);">
          Total file footprint across posts and comments.
        </p>
        <p style="margin:0;font-size:24px;font-weight:700;">
          <%= attachmentsTotalMB.toFixed(1) %> MB
        </p>
        <p style="margin:8px 0 0;font-size:13px;color:var(--ink-500);">
          Files: <strong><%= attachmentsCount %></strong>
        </p>
      </div>

      <!-- Engagement signals -->
      <div class="card">
        <h3 style="margin:0 0 4px;font-size:16px;color:var(--ink-900);">
          Engagement signals
        </h3>
        <p style="margin:0 0 8px;color:var(--ink-500);">
          Lightweight view of interactions in this tenant.
        </p>
        <p style="margin:0;font-size:14px;color:var(--ink-500);line-height:1.6;">
          • Posts: <strong><%= postsCount %></strong><br>
          • Comments: <strong><%= commentsCount %></strong><br>
          • Poll responses: <strong><%= pollResponsesCount %></strong><br>
          • Internal links: <strong><%= internalLinksCount %></strong>
        </p>
      </div>
    </div>
  </section>

      <!-- Groups in this company -->
      <section class="section" style="padding-top:12px;margin-top:8px;">
        <h2 class="h3" style="margin:0 0 12px;">Groups in this tenant</h2>
        <p class="sub" style="margin:0 0 16px;">
          Snapshot of groups, their privacy, and activity levels.
        </p>
  
        <% if (!groupsList || !groupsList.length) { %>
          <div class="card">
            <p style="margin:0;color:var(--ink-500);">
              No groups have been created in this company yet.
            </p>
          </div>
        <% } else { %>
          <div class="card" style="padding:0;overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;font-size:14px;">
              <thead>
                <tr style="background:var(--paper-2);">
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid rgba(15,23,42,.06);">
                    Name
                  </th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid rgba(15,23,42,.06);">
                    Privacy
                  </th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid rgba(15,23,42,.06);">
                    Membership
                  </th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid rgba(15,23,42,.06);">
                    Members
                  </th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid rgba(15,23,42,.06);">
                    Posts
                  </th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid rgba(15,23,42,.06);">
                    Created
                  </th>
                </tr>
              </thead>
              <tbody>
                <% groupsList.forEach(g => { %>
                  <tr>
                    <td style="padding:8px 12px;border-bottom:1px solid rgba(15,23,42,.04);max-width:220px;">
                      <div style="font-weight:600;color:var(--ink-900);">
                        <%= g.name %>
                      </div>
                      <% if (g.description) { %>
                        <div style="font-size:12px;color:var(--ink-500);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                          <%= g.description %>
                        </div>
                      <% } %>
                    </td>
                    <td style="padding:8px 12px;border-bottom:1px solid rgba(15,23,42,.04);">
                      <% if (g.isPrivate) { %>
                        <span style="font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(15,23,42,.06);">
                          Private
                        </span>
                      <% } else { %>
                        <span style="font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(34,197,94,.08);">
                          Public
                        </span>
                      <% } %>
                    </td>
                    <td style="padding:8px 12px;border-bottom:1px solid rgba(15,23,42,.04);text-transform:capitalize;font-size:13px;color:var(--ink-500);">
                      <%= g.membershipPolicy === 'by-approval' ? 'By approval' : 'Open' %>
                    </td>
                    <td style="padding:8px 12px;border-bottom:1px solid rgba(15,23,42,.04);text-align:right;">
                      <%= typeof g.membersCount === 'number' ? g.membersCount : (g.members ? g.members.length : 0) %>
                    </td>
                    <td style="padding:8px 12px;border-bottom:1px solid rgba(15,23,42,.04);text-align:right;">
                      <%= typeof g.postsCount === 'number' ? g.postsCount : 0 %>
                    </td>
                    <td style="padding:8px 12px;border-bottom:1px solid rgba(15,23,42,.04);white-space:nowrap;font-size:13px;color:var(--ink-500);">
                      <%= g.createdAt ? g.createdAt.toISOString().slice(0,10) : '—' %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <p class="sub" style="margin:8px 0 0;">
            Showing latest <%= groupsList.length %> groups (newest first).
          </p>
        <% } %>
      </section>

      
    <!-- Lower split: product, policies, integrations -->
    <section class="section" style="padding-top:12px;">
      <div class="split" style="grid-template-columns:1.3fr 1.1fr;">
        <!-- Product & policies -->
        <div>
          <div class="card" style="margin-bottom:16px;">
            <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Product & Branding</h3>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Product name: <strong><%= company.productName || '—' %></strong>
            </p>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Tagline: <%= company.tagline || '—' %>
            </p>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Locale: <%= company.locale %>
            </p>
            <p style="margin:0;color:var(--ink-500);">
              Brand theme:
              primary <code><%= company.branding?.theme?.primary || '#1976d2' %></code>,
              secondary <code><%= company.branding?.theme?.secondary || '#ffffff' %></code>
            </p>
          </div>

          <div class="card">
            <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Policies</h3>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Posting mode: <strong><%= company.policies?.postingMode || 'OPEN' %></strong>
            </p>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Retention (days): <%= company.policies?.retentionDays || 0 %>
            </p>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Notifications: <%= company.policies?.notificationsEnabled ? 'Enabled' : 'Disabled' %>
            </p>
            <p style="margin:0;color:var(--ink-500);">
              Blocked words: <%= (company.policies?.blockedWords || []).length %>
            </p>
          </div>
        </div>

        <!-- Integrations & verification details -->
        <div>
          <div class="card" style="margin-bottom:16px;">
            <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Integrations</h3>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              LinkedIn company ID: <%= company.integrations?.linkedinCompanyId || '—' %>
            </p>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              LinkedIn sync: <%= company.integrations?.enableLinkedInSync ? 'Enabled' : 'Disabled' %>
            </p>
            <p style="margin:0;color:var(--ink-500);">
              Last LinkedIn sync:
              <%= company.integrations?.lastLinkedInSyncAt
                    ? company.integrations.lastLinkedInSyncAt.toISOString().slice(0,10)
                    : '—' %>
            </p>
          </div>

          <div class="card">
            <h3 style="margin:0 0 6px;font-size:18px;color:var(--ink-900);">Verification details</h3>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Verify token set:
              <%= company.verifyToken ? 'Yes' : 'No' %>
            </p>
            <p style="margin:0 0 4px;color:var(--ink-500);">
              Verify expires at:
              <%= company.verifyExpiresAt ? company.verifyExpiresAt.toISOString().slice(0,10) : '—' %>
            </p>
            <p style="margin:0;color:var(--ink-500);">
              Verified at:
              <%= company.verifiedAt ? company.verifiedAt.toISOString().slice(0,10) : '—' %>
            </p>
          </div>
        </div>
      </div>
    </section>

          <!-- Audit trail -->
    <section class="section" style="padding-top:12px;margin-top:8px;">
      <h2 class="h3" style="margin:0 0 12px;">Audit trail (last 50 events)</h2>
      <p class="sub" style="margin:0 0 16px;">
        Recent configuration and policy changes recorded for this tenant.
      </p>

      <% if (!auditLogs || !auditLogs.length) { %>
        <div class="card">
          <p style="margin:0;color:var(--ink-500);">
            No audit events recorded for this company yet.
          </p>
        </div>
      <% } else { %>
        <div class="card" style="padding:0;overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr style="background:var(--paper-2);">
                <th style="text-align:left;padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.06);">
                  When
                </th>
                <th style="text-align:left;padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.06);">
                  Actor
                </th>
                <th style="text-align:left;padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.06);">
                  Action
                </th>
                <th style="text-align:left;padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.06);">
                  Target
                </th>
                <th style="text-align:left;padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.06);">
                  Details
                </th>
              </tr>
            </thead>
            <tbody>
              <% auditLogs.forEach(log => { %>
                <tr>
                  <!-- When -->
                  <td style="padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.04);white-space:nowrap;">
                    <%= log.createdAt ? log.createdAt.toISOString().slice(0,16).replace('T',' ') : '—' %>
                  </td>

                  <!-- Actor -->
                  <td style="padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.04);">
                    <% if (log.actorRole === 'SUPER_ADMIN') { %>
                      <span style="font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(59,130,246,.08);">
                        Super admin
                      </span>
                    <% } else if (log.actorUserId) { %>
                      <span style="font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(16,185,129,.08);">
                        Tenant user
                      </span>
                    <% } else { %>
                      <span style="font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(148,163,184,.25);">
                        System
                      </span>
                    <% } %>
                  </td>

                  <!-- Action -->
                  <td style="padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.04);font-family:ui-monospace,Menlo,Consolas,monospace;">
                    <%= log.action %>
                  </td>

                  <!-- Target -->
                  <td style="padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.04);font-size:12px;color:var(--ink-500);">
                    <% const tType = (log.targetType || 'company'); %>
                    <%= tType.charAt(0).toUpperCase() + tType.slice(1) %>
                    <% if (log.targetId) { %>
                      · <code><%= String(log.targetId).slice(-6) %></code>
                    <% } %>
                  </td>

                  <!-- Details (metadata/meta, truncated) -->
                  <td style="padding:8px 10px;border-bottom:1px solid rgba(15,23,42,.04);max-width:320px;">
                    <% 
                      const d = JSON.stringify(log.metadata || log.meta || {});
                      const out = d.length > 120 ? d.slice(0, 120) + '…' : d;
                    %>
                    <code style="font-family:ui-monospace,Menlo,Consolas,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;">
                      <%= out %>
                    </code>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <p class="sub" style="margin:8px 0 0;">
          Showing the latest <%= auditLogs.length %> events for this company.
        </p>
      <% } %>
    </section>


  </div>
</div>
